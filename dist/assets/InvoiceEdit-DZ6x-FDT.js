import{r as v,z as H,L as J,x as m,w as a,V as K,U as X,o as i,b as t,d as s,c as r,v as d,E as f,h as Y,e as w,f as u,i as k,af as D,ai as Z,j as E,F as M,aj as ee,n as g,R as te,O as N,ah as se,p as le,D as ae,Q as oe,B as ne,a4 as ie,a5 as de}from"./index-B0c0aplS.js";import{u as $}from"./useApi-C9JqAxpT.js";import{_ as ue,a as re}from"./ProductSelector-BIvAiJYM.js";import{_ as b}from"./AppButton-CoaWq9vh.js";import{_ as C}from"./AppCard-D6Bc5W2v.js";import{_ as h}from"./AppInput-B9V4fNt_.js";import{_ as ce}from"./LoadingSpinner-DEhea3Ta.js";import"./AppAutocomplete-Ch1LS0q9.js";const pe={class:"d-flex align-center justify-space-between mb-6"},me={class:"d-flex align-center"},_e={key:0,class:"text-body-1 text-grey"},ve={key:0,class:"d-flex justify-center align-center py-12"},fe={class:"pa-4"},ge={class:"d-flex align-center mb-4"},ye={class:"pa-4"},xe={class:"d-flex align-center mb-4"},be={class:"font-weight-medium"},he={key:0,class:"text-caption text-grey"},Ve={class:"text-center"},we={class:"text-left"},ke={class:"text-left text-error"},Ce={class:"text-left font-weight-bold text-success"},je={class:"text-center"},Ae={class:"pa-4"},$e={class:"d-flex align-center mb-4"},Ue={class:"d-flex flex-column gap-2"},Ie={class:"d-flex justify-space-between border-bottom pb-2"},Le={class:"font-weight-bold"},Be={class:"d-flex justify-space-between border-bottom pb-2"},Te={class:"font-weight-bold"},De={key:0,class:"d-flex justify-space-between"},Ee={class:"font-weight-bold"},Me={class:"text-primary text-caption font-weight-bold"},Ne={class:"font-weight-bold text-success"},Se={class:"d-flex align-center mb-4"},ze={class:"d-flex flex-column gap-2 mb-4"},Fe={class:"d-flex justify-space-between text-body-1"},Pe={class:"font-weight-medium"},Re={key:0,class:"d-flex justify-space-between text-body-1 text-error"},qe={key:1,class:"d-flex justify-space-between text-body-1"},Ge={key:2,class:"d-flex justify-space-between text-body-1"},Oe={class:"d-flex justify-space-between align-center px-4 py-3 bg-success-lighten-5 rounded-lg border border-success"},Qe={class:"text-h5 font-weight-black text-success"},We={class:"d-flex align-center justify-space-between pa-4"},He={key:1},Je={class:"d-flex gap-2"},ot={__name:"InvoiceEdit",setup(Ke){const U=le(),j=X(),I=$("/api/invoices"),{get:S}=$("/api/invoice-types"),{get:z}=$("/api/warehouses"),L=v(!0),A=v(!1),V=v(null),y=v(1),F=[{title:"معلومات الفاتورة",value:1},{title:"المنتجات",value:2},{title:"المراجعة",value:3}],l=v({customer:null,invoice_type_id:null,invoice_date:null,due_date:null,warehouse_id:null,items:[],discount_percentage:0,tax_percentage:14,shipping_cost:0}),B=v([]),T=v([]),_=H(()=>{const n=l.value.items.reduce((Q,W)=>Q+parseFloat(W.total),0),e=n*(l.value.discount_percentage/100),o=n-e,c=o*(l.value.tax_percentage/100),x=o+c+l.value.shipping_cost;return{subtotal:n,discountAmount:e,taxableAmount:o,taxAmount:c,total:x}}),P=()=>{U.push("/invoices")},R=n=>{l.value.customer=n},q=n=>{l.value.items.push(n)},G=n=>{l.value.items.splice(n,1)},O=async()=>{A.value=!0;try{const n={customer_id:l.value.customer.id,invoice_type_id:l.value.invoice_type_id,invoice_date:l.value.invoice_date,due_date:l.value.due_date,warehouse_id:l.value.warehouse_id,items:l.value.items,discount_percentage:l.value.discount_percentage,tax_percentage:l.value.tax_percentage,shipping_cost:l.value.shipping_cost,total:_.value.total};await I.update(j.params.id,n,{successMessage:"تم تحديث الفاتورة بنجاح"}),U.push(`/invoices/${j.params.id}`)}finally{A.value=!1}},p=n=>n?new Intl.NumberFormat("ar-EG",{style:"currency",currency:"EGP"}).format(n):"0.00 ج.م";return J(async()=>{try{const[n,e,o]=await Promise.all([I.getById(j.params.id),S({},{showLoading:!1}),z({},{showLoading:!1})]);V.value=n.data,B.value=e.data||[],T.value=o.data||[],l.value={customer:n.data.customer,invoice_type_id:n.data.invoice_type_id,invoice_date:n.data.invoice_date,due_date:n.data.due_date,warehouse_id:n.data.warehouse_id,items:n.data.items||[],discount_percentage:n.data.discount_percentage||0,tax_percentage:n.data.tax_percentage||14,shipping_cost:n.data.shipping_cost||0}}finally{L.value=!1}}),(n,e)=>(i(),m(K,{fluid:""},{default:a(()=>[t("div",pe,[t("div",me,[s(b,{icon:"ri-arrow-right-line",variant:"text",color:"secondary",onClick:P,class:"me-3"}),t("div",null,[e[11]||(e[11]=t("h1",{class:"text-h4 font-weight-bold"},"تعديل الفاتورة",-1)),V.value?(i(),r("p",_e,"فاتورة رقم #"+d(V.value.invoice_number),1)):f("",!0)])])]),L.value?(i(),r("div",ve,[s(ce)])):V.value?(i(),m(Y,{key:1},{default:a(()=>[s(se,{modelValue:y.value,"onUpdate:modelValue":e[10]||(e[10]=o=>y.value=o),items:F,"alt-labels":""},{"item.1":a(()=>[t("div",fe,[s(w,null,{default:a(()=>[s(u,{cols:"12"},{default:a(()=>[t("div",ge,[s(k,{icon:"ri-user-settings-line",color:"primary",class:"me-2"}),e[12]||(e[12]=t("h3",{class:"text-h6 font-weight-bold"},"معلومات العميل والفاتورة",-1))])]),_:1}),s(u,{cols:"12",md:"6"},{default:a(()=>[s(ue,{modelValue:l.value.customer,"onUpdate:modelValue":[e[0]||(e[0]=o=>l.value.customer=o),R]},null,8,["modelValue"])]),_:1}),s(u,{cols:"12",md:"6"},{default:a(()=>[s(D,{modelValue:l.value.invoice_type_id,"onUpdate:modelValue":e[1]||(e[1]=o=>l.value.invoice_type_id=o),items:B.value,"item-title":"name","item-value":"id",label:"نوع الفاتورة *",variant:"outlined",density:"comfortable","prepend-inner-icon":"ri-file-copy-line"},null,8,["modelValue","items"])]),_:1}),s(u,{cols:"12",md:"4"},{default:a(()=>[s(h,{modelValue:l.value.invoice_date,"onUpdate:modelValue":e[2]||(e[2]=o=>l.value.invoice_date=o),type:"date",label:"تاريخ الفاتورة *","prepend-inner-icon":"ri-calendar-line"},null,8,["modelValue"])]),_:1}),s(u,{cols:"12",md:"4"},{default:a(()=>[s(h,{modelValue:l.value.due_date,"onUpdate:modelValue":e[3]||(e[3]=o=>l.value.due_date=o),type:"date",label:"تاريخ الاستحقاق","prepend-inner-icon":"ri-calendar-check-line"},null,8,["modelValue"])]),_:1}),s(u,{cols:"12",md:"4"},{default:a(()=>[s(D,{modelValue:l.value.warehouse_id,"onUpdate:modelValue":e[4]||(e[4]=o=>l.value.warehouse_id=o),items:T.value,"item-title":"name","item-value":"id",label:"المخزن",variant:"outlined",density:"comfortable","prepend-inner-icon":"ri-building-line"},null,8,["modelValue","items"])]),_:1})]),_:1})])]),"item.2":a(()=>[t("div",ye,[s(w,null,{default:a(()=>[s(u,{cols:"12"},{default:a(()=>[t("div",xe,[s(k,{icon:"ri-shopping-bag-line",color:"primary",class:"me-2"}),e[13]||(e[13]=t("h3",{class:"text-h6 font-weight-bold"},"المنتجات",-1))])]),_:1}),s(u,{cols:"12"},{default:a(()=>[s(re,{onAdd:q})]),_:1}),l.value.items.length>0?(i(),m(u,{key:0,cols:"12"},{default:a(()=>[s(C,{class:"mt-4",title:"المنتجات المحددة",subtitle:`إجمالي العناصر: ${l.value.items.length}`,icon:"ri-list-check-2"},{default:a(()=>[s(Z,null,{default:a(()=>[e[14]||(e[14]=t("thead",null,[t("tr",null,[t("th",{class:"text-right"},"المنتج"),t("th",{class:"text-center"},"الكمية"),t("th",{class:"text-left"},"السعر"),t("th",{class:"text-left"},"الخصم"),t("th",{class:"text-left"},"الإجمالي"),t("th",{class:"text-center"},"إجراءات")])],-1)),t("tbody",null,[(i(!0),r(M,null,E(l.value.items,(o,c)=>(i(),r("tr",{key:c},[t("td",null,[t("div",be,d(o.product_name),1),o.variant_name?(i(),r("div",he,d(o.variant_name),1)):f("",!0)]),t("td",Ve,[s(ae,{size:"small",variant:"tonal",color:"primary"},{default:a(()=>[g(d(o.quantity),1)]),_:2},1024)]),t("td",we,d(p(o.unit_price)),1),t("td",ke,d(o.discount_percentage)+"%",1),t("td",Ce,d(p(o.total)),1),t("td",je,[s(b,{icon:"ri-delete-bin-line",size:"x-small",variant:"text",color:"error",tooltip:"حذف",onClick:x=>G(c)},null,8,["onClick"])])]))),128))])]),_:1})]),_:1},8,["subtitle"])]),_:1})):(i(),m(u,{key:1,cols:"12"},{default:a(()=>[s(ee,{type:"info",variant:"tonal",border:"start"},{default:a(()=>e[15]||(e[15]=[g(" لم يتم إضافة منتجات بعد. ابحث عن منتج أعلاه للإضافة. ")])),_:1})]),_:1}))]),_:1})])]),"item.3":a(()=>[t("div",Ae,[s(w,null,{default:a(()=>[s(u,{cols:"12",md:"7"},{default:a(()=>[t("div",$e,[s(k,{icon:"ri-eye-line",color:"primary",class:"me-2"}),e[16]||(e[16]=t("h3",{class:"text-h6 font-weight-bold"},"مراجعة التعديلات",-1))]),s(C,{title:"معلومات العميل",icon:"ri-user-line",class:"mb-6"},{default:a(()=>{var o,c,x;return[t("div",Ue,[t("div",Ie,[e[17]||(e[17]=t("span",{class:"text-grey"},"الاسم:",-1)),t("span",Le,d((o=l.value.customer)==null?void 0:o.name),1)]),t("div",Be,[e[18]||(e[18]=t("span",{class:"text-grey"},"الهاتف:",-1)),t("span",Te,d((c=l.value.customer)==null?void 0:c.phone),1)]),(x=l.value.customer)!=null&&x.email?(i(),r("div",De,[e[19]||(e[19]=t("span",{class:"text-grey"},"البريد:",-1)),t("span",Ee,d(l.value.customer.email),1)])):f("",!0)])]}),_:1}),s(C,{title:"ملخص المنتجات",icon:"ri-shopping-cart-2-line"},{default:a(()=>[s(te,{density:"compact"},{default:a(()=>[(i(!0),r(M,null,E(l.value.items,(o,c)=>(i(),m(oe,{key:c,class:"px-0"},{prepend:a(()=>[s(ne,{size:"32",color:"primary-lighten-5",class:"me-3"},{default:a(()=>[t("span",Me,d(o.quantity),1)]),_:2},1024)]),append:a(()=>[t("span",Ne,d(p(o.total)),1)]),default:a(()=>[s(ie,{class:"font-weight-medium"},{default:a(()=>[g(d(o.product_name),1)]),_:2},1024),s(de,null,{default:a(()=>[g(d(p(o.unit_price)),1)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})]),_:1}),s(u,{cols:"12",md:"5"},{default:a(()=>[t("div",Se,[s(k,{icon:"ri-secure-payment-line",color:"primary",class:"me-2"}),e[20]||(e[20]=t("h3",{class:"text-h6 font-weight-bold"},"الخصومات والضرائب",-1))]),s(C,null,{default:a(()=>[s(w,{dense:""},{default:a(()=>[s(u,{cols:"6"},{default:a(()=>[s(h,{modelValue:l.value.discount_percentage,"onUpdate:modelValue":e[5]||(e[5]=o=>l.value.discount_percentage=o),modelModifiers:{number:!0},label:"خصم %",type:"number","prepend-inner-icon":"ri-percent-line"},null,8,["modelValue"])]),_:1}),s(u,{cols:"6"},{default:a(()=>[s(h,{modelValue:l.value.tax_percentage,"onUpdate:modelValue":e[6]||(e[6]=o=>l.value.tax_percentage=o),modelModifiers:{number:!0},label:"ضريبة %",type:"number","prepend-inner-icon":"ri-percent-line"},null,8,["modelValue"])]),_:1}),s(u,{cols:"12"},{default:a(()=>[s(h,{modelValue:l.value.shipping_cost,"onUpdate:modelValue":e[7]||(e[7]=o=>l.value.shipping_cost=o),modelModifiers:{number:!0},label:"تكلفة الشحن",type:"number","prepend-inner-icon":"ri-truck-line"},null,8,["modelValue"])]),_:1})]),_:1}),s(N,{class:"my-4"}),t("div",ze,[t("div",Fe,[e[21]||(e[21]=t("span",{class:"text-grey"},"المجموع الفرعي:",-1)),t("span",Pe,d(p(_.value.subtotal)),1)]),_.value.discountAmount>0?(i(),r("div",Re,[e[22]||(e[22]=t("span",null,"إجمالي الخصم:",-1)),t("span",null,"-"+d(p(_.value.discountAmount)),1)])):f("",!0),_.value.taxAmount>0?(i(),r("div",qe,[e[23]||(e[23]=t("span",{class:"text-grey"},"إجمالي الضريبة:",-1)),t("span",null,d(p(_.value.taxAmount)),1)])):f("",!0),l.value.shipping_cost>0?(i(),r("div",Ge,[e[24]||(e[24]=t("span",{class:"text-grey"},"تكلفة الشحن:",-1)),t("span",null,d(p(l.value.shipping_cost)),1)])):f("",!0)]),t("div",Oe,[e[25]||(e[25]=t("span",{class:"text-h6 font-weight-bold text-success"},"الإجمالي النهائي:",-1)),t("span",Qe,d(p(_.value.total)),1)])]),_:1})]),_:1})]),_:1})])]),actions:a(()=>[s(N),t("div",We,[y.value>1?(i(),m(b,{key:0,variant:"outlined",color:"secondary","prepend-icon":"ri-arrow-right-line",onClick:e[8]||(e[8]=o=>y.value--)},{default:a(()=>e[26]||(e[26]=[g(" السابق ")])),_:1})):(i(),r("div",He)),t("div",Je,[y.value<3?(i(),m(b,{key:0,"append-icon":"ri-arrow-left-line",onClick:e[9]||(e[9]=o=>y.value++)},{default:a(()=>e[27]||(e[27]=[g(" التالي ")])),_:1})):(i(),m(b,{key:1,color:"success","prepend-icon":"ri-save-line",loading:A.value,onClick:O},{default:a(()=>e[28]||(e[28]=[g(" حفظ التعديلات ")])),_:1},8,["loading"]))])])]),_:1},8,["modelValue"])]),_:1})):f("",!0)]),_:1}))}};export{ot as default};
