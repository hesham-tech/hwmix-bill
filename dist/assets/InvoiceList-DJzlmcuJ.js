import{r as c,x as L,I as le,m as oe,S as _e,o as I,s as U,w as o,a as i,t as C,b as n,z as be,g as X,l as $,B as ae,u as p,C as q,J as he,d as xe,e as j,a8 as Y,V as Ve,a9 as Pe,N as ke,p as Z}from"./index-CuR9-sbN.js";import{u as ne}from"./useApi-CjhFmPue.js";import{u as se}from"./usePermissions-FLd-5AYP.js";import{A as we}from"./AppDataTable-CnA5lOqV.js";import{_ as z}from"./AppButton-CREzoRf6.js";import{_ as ie}from"./AppCard-CXpBKc1t.js";import{_ as ee}from"./AppInput-06Y7zOXl.js";import{A as Ce}from"./AppDialog-vLCI3uF9.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";function Se(S,T={}){const V=oe(),m=_e(),{initialPage:s=1,initialPerPage:B=10,initialSortBy:A="id",initialSortOrder:N="desc",syncWithUrl:g=!0}=T,u=c([]),b=c(!1),D=c(null),r=c(g&&parseInt(m.query.page)||s),y=c(g&&parseInt(m.query.per_page)||B),x=c(0),t=c(1),a=c(g&&m.query.sort_by||A),e=c(g&&m.query.sort_order||N),v=c(g&&m.query.search||""),_=c(g?JSON.parse(m.query.filters||"{}"):{}),d=c([]),P=c(!1),J=L(()=>u.value.length>0),M=L(()=>!b.value&&u.value.length===0),W=L(()=>d.value.length>0),H=L(()=>Math.ceil(x.value/y.value)),K=L(()=>{const l=(r.value-1)*y.value+1,w=Math.min(r.value*y.value,x.value);return{from:l,to:w,total:x.value}}),k=async()=>{var l,w,E;b.value=!0,D.value=null;try{const O={page:r.value,per_page:y.value,sort_by:a.value,sort_order:e.value};v.value&&(O.search=v.value),Object.entries(_.value).forEach(([ye,G])=>{G!=null&&G!==""&&(O[ye]=G)});const F=await S(O);u.value=F.data||[],x.value=((l=F.meta)==null?void 0:l.total)||F.total||0,t.value=((w=F.meta)==null?void 0:w.last_page)||F.last_page||1,r.value=((E=F.meta)==null?void 0:E.current_page)||F.current_page||1,g&&Q()}catch(O){D.value=O.message||"حدث خطأ في تحميل البيانات",console.error("DataTable fetch error:",O)}finally{b.value=!1}},Q=()=>{const l={page:r.value,per_page:y.value,sort_by:a.value,sort_order:e.value};v.value&&(l.search=v.value),Object.keys(_.value).length>0&&(l.filters=JSON.stringify(_.value)),V.replace({query:l})},h=l=>{r.value=l,k()},f=l=>{y.value=l,r.value=1,k()},R=l=>{a.value===l?e.value=e.value==="asc"?"desc":"asc":(a.value=l,e.value="asc"),k()};let te;const re=l=>{clearTimeout(te),te=setTimeout(()=>{v.value=l,r.value=1,k()},500)},ce=l=>{_.value={...l},r.value=1,k()},ue=()=>{_.value={},v.value="",r.value=1,k()},de=(l,w)=>{const E=u.value.findIndex(O=>O.id===l);E!==-1&&(u.value[E]={...u.value[E],...w})},pe=l=>{u.value=u.value.filter(w=>w.id!==l),x.value--},me=l=>{const w=d.value.indexOf(l);w===-1?d.value.push(l):d.value.splice(w,1)},ve=()=>{P.value?d.value=u.value.map(l=>l.id):d.value=[]},fe=()=>{d.value=[],P.value=!1},ge=()=>{k()};return le(P,ve),k(),{items:u,loading:b,error:D,currentPage:r,perPage:y,total:x,lastPage:t,sortBy:a,sortOrder:e,search:v,filters:_,selectedIds:d,selectAll:P,hasItems:J,isEmpty:M,hasSelection:W,totalPages:H,paginationInfo:K,fetchData:k,changePage:h,changePerPage:f,changeSort:R,performSearch:re,applyFilters:ce,resetFilters:ue,updateItem:de,removeItem:pe,toggleSelection:me,clearSelection:fe,refresh:ge}}const Ie={class:"text-primary font-weight-bold"},Ue={class:"d-flex align-center py-2"},$e={class:"text-primary font-weight-bold"},Te={class:"d-flex flex-column"},Ae={class:"font-weight-bold text-body-2"},De={class:"text-caption text-grey"},ze={class:"d-flex flex-column"},Be={class:"text-body-2"},Ne={class:"text-caption text-error font-weight-medium"},Oe={class:"d-flex flex-column align-end"},Fe={class:"font-weight-bold text-success"},qe={class:"text-caption text-grey"},Ee={class:"d-flex gap-1 justify-center"},je={__name:"InvoiceDataTable",props:{items:{type:Array,default:()=>[]},loading:{type:Boolean,default:!1},total:{type:Number,default:0},currentPage:{type:Number,default:1},perPage:{type:Number,default:10}},emits:["view","edit","print","delete","update:page","update:perPage","update:sortBy"],setup(S,{emit:T}){const V=T,{can:m}=se(),s=[{title:"رقم الفاتورة",key:"invoice_number",sortable:!0},{title:"العميل",key:"customer",sortable:!1},{title:"التاريخ",key:"invoice_date",sortable:!0},{title:"المبلغ",key:"total",sortable:!0,align:"end"},{title:"الحالة",key:"status",sortable:!0},{title:"حالة الدفع",key:"payment_status",sortable:!0},{title:"الإجراءات",key:"actions",sortable:!1,align:"center"}],B=t=>{V("update:page",t)},A=t=>{V("update:perPage",t)},N=t=>{V("update:sortBy",t)},g=t=>t?new Date(t).toLocaleDateString("ar-EG"):"-",u=t=>t?new Intl.NumberFormat("ar-EG",{style:"currency",currency:"EGP"}).format(t):"0.00 ج.م",b=t=>({draft:"grey",pending:"warning",approved:"success",cancelled:"error"})[t]||"grey",D=t=>({draft:"مسودة",pending:"قيد الانتظار",approved:"معتمدة",cancelled:"ملغاة"})[t]||t,r=t=>({unpaid:"error",partial:"warning",paid:"success"})[t]||"grey",y=t=>({unpaid:"ri-close-circle-line",partial:"ri-pie-chart-line",paid:"ri-checkbox-circle-line"})[t]||"ri-question-line",x=t=>({unpaid:"غير مدفوعة",partial:"مدفوعة جزئياً",paid:"مدفوعة بالكامل"})[t]||t;return(t,a)=>(I(),U(we,{headers:s,items:S.items,loading:S.loading,"total-items":S.total,page:S.currentPage,"items-per-page":S.perPage,"onUpdate:page":B,"onUpdate:itemsPerPage":A,"onUpdate:options":N},{"item.invoice_number":o(({item:e})=>[i("div",Ie,"#"+C(e.invoice_number),1)]),"item.customer":o(({item:e})=>{var v,_;return[i("div",Ue,[n(be,{size:"36",color:"primary-lighten-5",class:"me-3 border"},{default:o(()=>{var d,P;return[i("span",$e,C((P=(d=e.customer)==null?void 0:d.name)==null?void 0:P.charAt(0).toUpperCase()),1)]}),_:2},1024),i("div",Te,[i("span",Ae,C((v=e.customer)==null?void 0:v.name),1),i("span",De,[n(X,{icon:"ri-phone-line",size:"12",class:"me-1"}),$(" "+C(((_=e.customer)==null?void 0:_.phone)||"لا يوجد رقم"),1)])])])]}),"item.invoice_date":o(({item:e})=>[i("div",ze,[i("span",Be,C(g(e.invoice_date)),1),i("span",Ne,[n(X,{icon:"ri-time-line",size:"12",class:"me-1"}),$(" "+C(g(e.due_date)),1)])])]),"item.total":o(({item:e})=>[i("div",Oe,[i("span",Fe,C(u(e.total)),1),i("span",qe,"المدفوع: "+C(u(e.paid_amount)),1)])]),"item.status":o(({item:e})=>[n(ae,{color:b(e.status),size:"small",variant:"flat",class:"font-weight-bold"},{default:o(()=>[$(C(D(e.status)),1)]),_:2},1032,["color"])]),"item.payment_status":o(({item:e})=>[n(ae,{color:r(e.payment_status),size:"small",variant:"tonal",class:"font-weight-bold"},{default:o(()=>[n(X,{icon:y(e.payment_status),size:"14",class:"me-1"},null,8,["icon"]),$(" "+C(x(e.payment_status)),1)]),_:2},1032,["color"])]),"item.actions":o(({item:e})=>[i("div",Ee,[n(z,{icon:"ri-eye-line",size:"x-small",variant:"text",color:"info",tooltip:"عرض",onClick:v=>t.$emit("view",e)},null,8,["onClick"]),p(m)("invoices.update_all")?(I(),U(z,{key:0,icon:"ri-edit-line",size:"x-small",variant:"text",color:"primary",tooltip:"تعديل",onClick:v=>t.$emit("edit",e)},null,8,["onClick"])):q("",!0),p(m)("invoices.print")?(I(),U(z,{key:1,icon:"ri-printer-line",size:"x-small",variant:"text",color:"warning",tooltip:"طباعة",onClick:v=>t.$emit("print",e)},null,8,["onClick"])):q("",!0),p(m)("invoices.delete_all")?(I(),U(z,{key:2,icon:"ri-delete-bin-line",size:"x-small",variant:"text",color:"error",tooltip:"حذف",onClick:v=>t.$emit("delete",e)},null,8,["onClick"])):q("",!0)])]),_:1},8,["items","loading","total-items","page","items-per-page"]))}},Le={class:"d-flex gap-2 mt-4"},Re={__name:"InvoiceFilters",props:{modelValue:{type:Object,default:()=>({})}},emits:["update:modelValue","apply"],setup(S,{emit:T}){const V=S,m=T,s=c({search:"",invoice_type_id:null,status:null,payment_status:null,date_from:null,date_to:null,...V.modelValue}),{get:B}=ne("/api/invoice-types"),A=c([]),N=[{label:"مسودة",value:"draft"},{label:"قيد الانتظار",value:"pending"},{label:"معتمدة",value:"approved"},{label:"ملغاة",value:"cancelled"}],g=[{label:"غير مدفوعة",value:"unpaid"},{label:"مدفوعة جزئياً",value:"partial"},{label:"مدفوعة بالكامل",value:"paid"}],u=L(()=>Object.values(s.value).some(t=>t!==null&&t!==""));let b;const D=()=>{clearTimeout(b),b=setTimeout(()=>{r()},500)},r=()=>{m("update:modelValue",{...s.value}),m("apply",{...s.value})},y=()=>{s.value={search:"",invoice_type_id:null,status:null,payment_status:null,date_from:null,date_to:null},r()},x=async()=>{try{const t=await B({},{showLoading:!1,showError:!1});A.value=t.data||[]}catch(t){console.error("Error loading invoice types:",t)}};return le(()=>V.modelValue,t=>{s.value={...t}},{deep:!0}),he(()=>{x()}),(t,a)=>(I(),U(ie,{class:"mb-6",title:"تصفية الفواتير",icon:"ri-filter-3-line"},{actions:o(()=>[u.value?(I(),U(z,{key:0,variant:"text",color:"error","prepend-icon":"ri-close-circle-line",onClick:y},{default:o(()=>a[6]||(a[6]=[$(" مسح الكل ")])),_:1})):q("",!0)]),default:o(()=>[n(xe,null,{default:o(()=>[n(j,{cols:"12",md:"4"},{default:o(()=>[n(ee,{modelValue:s.value.search,"onUpdate:modelValue":[a[0]||(a[0]=e=>s.value.search=e),D],label:"بحث...",placeholder:"رقم الفاتورة، اسم العميل، رقم الهاتف","prepend-inner-icon":"ri-search-line",clearable:""},null,8,["modelValue"])]),_:1}),n(j,{cols:"12",md:"4"},{default:o(()=>[n(Y,{modelValue:s.value.invoice_type_id,"onUpdate:modelValue":a[1]||(a[1]=e=>s.value.invoice_type_id=e),items:A.value,"item-title":"name","item-value":"id",label:"نوع الفاتورة",variant:"outlined",density:"comfortable","prepend-inner-icon":"ri-file-copy-line",clearable:"","hide-details":""},null,8,["modelValue","items"])]),_:1}),n(j,{cols:"12",md:"4"},{default:o(()=>[n(Y,{modelValue:s.value.status,"onUpdate:modelValue":a[2]||(a[2]=e=>s.value.status=e),items:N,"item-title":"label","item-value":"value",label:"حالة الفاتورة",variant:"outlined",density:"comfortable","prepend-inner-icon":"ri-checkbox-circle-line",clearable:"","hide-details":""},null,8,["modelValue"])]),_:1}),n(j,{cols:"12",md:"4"},{default:o(()=>[n(Y,{modelValue:s.value.payment_status,"onUpdate:modelValue":a[3]||(a[3]=e=>s.value.payment_status=e),items:g,"item-title":"label","item-value":"value",label:"حالة الدفع",variant:"outlined",density:"comfortable","prepend-inner-icon":"ri-money-dollar-circle-line",clearable:"","hide-details":""},null,8,["modelValue"])]),_:1}),n(j,{cols:"12",md:"4"},{default:o(()=>[n(ee,{modelValue:s.value.date_from,"onUpdate:modelValue":a[4]||(a[4]=e=>s.value.date_from=e),type:"date",label:"من تاريخ","prepend-inner-icon":"ri-calendar-line",clearable:""},null,8,["modelValue"])]),_:1}),n(j,{cols:"12",md:"4"},{default:o(()=>[n(ee,{modelValue:s.value.date_to,"onUpdate:modelValue":a[5]||(a[5]=e=>s.value.date_to=e),type:"date",label:"إلى تاريخ","prepend-inner-icon":"ri-calendar-line",clearable:""},null,8,["modelValue"])]),_:1})]),_:1}),i("div",Le,[n(z,{"prepend-icon":"ri-search-line",onClick:r},{default:o(()=>a[7]||(a[7]=[$(" بحث وتصفية ")])),_:1}),n(z,{variant:"outlined",color:"secondary","prepend-icon":"ri-refresh-line",onClick:y},{default:o(()=>a[8]||(a[8]=[$(" إعادة تعيين ")])),_:1})])]),_:1}))}},Ge={class:"d-flex align-center justify-space-between mb-6"},Je={class:"d-flex align-center px-4 py-2"},Me={class:"text-primary font-weight-bold"},at={__name:"InvoiceList",setup(S){const T=oe(),{can:V}=se(),m=ne("/api/invoices"),s=async h=>await m.get(h,{showLoading:!1}),{items:B,loading:A,currentPage:N,perPage:g,total:u,filters:b,selectedIds:D,hasSelection:r,changePage:y,changePerPage:x,changeSort:t,applyFilters:a,removeItem:e,refresh:v}=Se(s,{initialPerPage:10,syncWithUrl:!0}),_=c(!1),d=c(null),P=c(!1),J=()=>{T.push("/invoices/create")},M=h=>{T.push(`/invoices/${h.id}`)},W=h=>{T.push(`/invoices/${h.id}/edit`)},H=async h=>{try{Z.info("جاري تجهيز الفاتورة للطباعة..."),window.open(`/api/invoice/${h.id}/pdf`,"_blank")}catch{Z.error("فشل في طباعة الفاتورة")}},K=h=>{d.value=h,_.value=!0},k=async()=>{if(d.value){P.value=!0;try{await m.remove(d.value.id),e(d.value.id),_.value=!1,d.value=null}catch{}finally{P.value=!1}}},Q=()=>{Z.info("ميزة الحذف الجماعي قيد التطوير")};return(h,f)=>(I(),U(Ve,{fluid:""},{default:o(()=>[i("div",Ge,[f[3]||(f[3]=i("div",null,[i("h1",{class:"text-h4 font-weight-bold"},"الفواتير"),i("p",{class:"text-body-1 text-grey"},"إدارة جميع الفواتير الصادرة والواردة")],-1)),p(V)("invoices.create")?(I(),U(z,{key:0,"prepend-icon":"ri-add-line",size:"large",onClick:J},{default:o(()=>f[2]||(f[2]=[$(" فاتورة جديدة ")])),_:1})):q("",!0)]),n(Re,{modelValue:p(b),"onUpdate:modelValue":f[0]||(f[0]=R=>Pe(b)?b.value=R:null),onApply:p(a)},null,8,["modelValue","onApply"]),p(r)?(I(),U(ie,{key:0,class:"mb-4",color:"primary",variant:"tonal"},{default:o(()=>[i("div",Je,[i("div",Me,"تم تحديد "+C(p(D).length)+" فاتورة",1),n(ke),p(V)("invoices.delete_all")?(I(),U(z,{key:0,variant:"outlined",color:"error","prepend-icon":"ri-delete-bin-line",onClick:Q},{default:o(()=>f[4]||(f[4]=[$(" حذف المحدد ")])),_:1})):q("",!0)])]),_:1})):q("",!0),n(je,{items:p(B),loading:p(A),total:p(u),"current-page":p(N),"per-page":p(g),onView:M,onEdit:W,onPrint:H,onDelete:K,"onUpdate:page":p(y),"onUpdate:perPage":p(x),"onUpdate:sortBy":p(t)},null,8,["items","loading","total","current-page","per-page","onUpdate:page","onUpdate:perPage","onUpdate:sortBy"]),n(Ce,{modelValue:_.value,"onUpdate:modelValue":f[1]||(f[1]=R=>_.value=R),title:"تأكيد الحذف",icon:"ri-delete-bin-line","confirm-color":"error","confirm-text":"حذف الفاتورة",loading:P.value,onConfirm:k},{default:o(()=>f[5]||(f[5]=[$(" هل أنت متأكد من حذف هذه الفاتورة؟ لا يمكن التراجع عن هذا الإجراء. ")])),_:1},8,["modelValue","loading"])]),_:1}))}};export{at as default};
