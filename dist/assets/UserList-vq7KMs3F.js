import{_ as X}from"./AppInput-06Y7zOXl.js";import{x as G,r as I,J as fe,I as de,o as u,c as E,b as e,w as a,a as l,z as W,s as x,A as _e,g as b,E as T,j as ue,am as ze,ac as ce,l as C,C as O,d as le,e as U,M as oe,u as n,a8 as me,f as H,t as y,i as Pe,F as Z,h as ee,aw as Me,ax as Se,ay as he,B as ae,aj as je,K as Ie,a1 as Ee,az as xe,ah as Oe,aA as Be,aB as Le,Q as Ae,O as De,a2 as Fe,y as Re,a3 as Te,v as Ge,a9 as se,aC as Ne,ai as qe,N as We}from"./index-CuR9-sbN.js";import{u as ne}from"./user.store-BDZKfgeE.js";import{u as be,a as He}from"./index-Jdh_M4Dc.js";import{M as Je}from"./MediaGallery-DgiLIKzw.js";import{A as Qe}from"./AppSwitch-CXzOvU1j.js";import{_ as pe}from"./AppButton-CREzoRf6.js";import{r as te,p as Ye,e as Xe,m as Ze}from"./validators-DqnElXnw.js";import{_ as we}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{A as Ke}from"./AppDataTable-CnA5lOqV.js";import{A as el}from"./AppDialog-vLCI3uF9.js";import{A as ll}from"./AppInfiniteScroll-616_I-vy.js";import{C as al}from"./ConfirmDialog-n7Qh7NLn.js";import"./useApi-CjhFmPue.js";function sl(){const g=ne(),{isOpen:c,formData:P,isEditMode:L,open:_,close:B}=be(),{isOpen:z,formData:M,open:$,close:V}=be(),{showConfirm:w,confirmMessage:D,confirm:q,handleConfirm:N,handleCancel:i}=He(),J=G(()=>g.users),A=G(()=>g.loading),R=G(()=>g.totalItems),S=async(p=!1)=>{await g.fetchUsers({append:p})};return{users:J,loading:A,totalItems:R,formData:P,isEditMode:L,isOpen:c,open:_,close:B,showConfirm:w,confirmMessage:D,handleConfirm:async()=>{await N(),await S()},handleCancel:i,isPermissionOpen:z,permissionUser:M,openPermissions:$,closePermissions:V,loadUsers:S,loadUser:async p=>await g.fetchUser(p),saveUser:async p=>L.value?await g.updateUser(P.value.id,p):await g.createUser(p),handleDelete:p=>{const k=p.nickname||p.full_name||p.name||"هذا المستخدم";q(`هل أنت متأكد من حذف المستخدم "${k}"؟`,async()=>{await g.deleteUser(p.id)})},handleEdit:p=>{_(p)},handleCreate:()=>{_({})},assignRole:async(p,k)=>{await g.assignRole(p,k)},updatePermissions:async(p,k)=>{await g.updatePermissions(p,k)}}}const tl={class:"user-form-container"},ol={class:"d-flex justify-center mb-8"},nl={class:"change-overlay d-flex flex-column align-center justify-center"},il={class:"d-flex align-center justify-space-between flex-wrap gap-2"},rl={class:"d-flex align-center gap-2 mb-2 text-primary font-weight-bold"},dl={class:"d-flex align-center gap-2 mb-2 text-warning font-weight-bold"},ul={class:"ms-2 font-weight-bold"},cl={class:"d-flex justify-end gap-3 mt-8"},ml={__name:"UserForm",props:{modelValue:{type:Object,default:()=>({})},isEditMode:{type:Boolean,default:!1}},emits:["save","cancel"],setup(g,{emit:c}){var S;const P=g,L=c,_=ne(),B=I(null),z=I(!1),M=I(!1),$=I(((S=P.modelValue)==null?void 0:S.avatar_url)||null),V=I(null),w=I(null),D=I({phone:!1,email:!1}),q=async v=>{const t=i.value[v];if(!(!t||t.length<3)&&!(v==="email"&&!t.includes("@"))&&!(v==="phone"&&t.length<8)){V.value=v;try{const d=await _.lookupUser({[v]:t});d&&typeof d=="object"&&Object.keys(d).length>0?(w.value=d,D.value[v]=!0,i.value.id=d.id,i.value.full_name=d.full_name||i.value.full_name,i.value.nickname=d.nickname||i.value.nickname,i.value.username=d.username||i.value.username,i.value.email=d.email||i.value.email,i.value.phone=d.phone||i.value.phone,d.avatar_url&&($.value=d.avatar_url)):(w.value=null,D.value[v]=!0)}catch(d){console.error("Lookup failed:",d)}finally{V.value=null}}},N=()=>{i.value={full_name:"",nickname:"",username:"",email:"",phone:"",password:"",role:"sales",is_active:!0,address:"",notes:"",images_ids:[]},$.value=null,w.value=null,D.value={phone:!1,email:!1}},i=I({full_name:"",nickname:"",username:"",email:"",phone:"",password:"",role:"sales",is_active:!0,address:"",notes:"",images_ids:[],...P.modelValue});fe(()=>{_.fetchRoles()});const J=G(()=>[..._.roles.map(v=>({title:v.label||v.name,value:v.name})),{title:"عميل",value:"customer"}]),A=v=>{i.value.images_ids=[v.id],$.value=v.url},R=async()=>{const{valid:v}=await B.value.validate();if(v){z.value=!0;try{const t={...i.value};t.status=t.is_active?"active":"inactive",P.isEditMode&&!t.password&&delete t.password,L("save",t)}finally{z.value=!1}}};return de(()=>P.modelValue,v=>{v&&(i.value={...i.value,...v},v.avatar_url&&($.value=v.avatar_url))},{deep:!0,immediate:!0}),(v,t)=>(u(),E("div",tl,[e(Pe,{ref_key:"formRef",ref:B,onSubmit:ue(R,["prevent"]),class:"user-form pa-4"},{default:a(()=>[l("div",ol,[l("div",{class:"avatar-selection-zone position-relative cursor-pointer",onClick:t[1]||(t[1]=d=>M.value=!0)},[e(W,{size:"120",color:$.value?void 0:"primary-lighten-5",class:"border-2 border-dashed elevation-2 hover-scale overflow-hidden"},{default:a(()=>[$.value?(u(),x(_e,{key:0,src:$.value,cover:""},null,8,["src"])):(u(),x(b,{key:1,icon:"ri-user-add-line",size:"40",color:"primary-lighten-1"})),l("div",nl,[e(b,{icon:"ri-camera-switch-line",color:"white",size:"24"}),t[14]||(t[14]=l("span",{class:"text-white text-caption mt-1 font-weight-bold"},"تغيير الصورة",-1))])]),_:1},8,["color"]),e(T,{icon:"ri-gallery-line",size:"x-small",color:"primary",class:"position-absolute bottom-0 right-0 elevation-4",onClick:t[0]||(t[0]=ue(d=>M.value=!0,["stop"]))})])]),e(ze,null,{default:a(()=>[w.value&&!g.isEditMode?(u(),x(ce,{key:0,type:"info",variant:"tonal",class:"mb-6 rounded-xl border-primary animate__animated animate__fadeIn","prepend-icon":"ri-user-shared-line"},{default:a(()=>[l("div",il,[t[16]||(t[16]=l("div",null,[l("div",{class:"font-weight-bold"},"تم العثور على مستخدم موجود مسبقاً!"),l("div",{class:"text-caption"},"سيتم ربط هذا المستخدم بالشركة الحالية مع الحفاظ على هويته العالمية.")],-1)),e(T,{size:"small",variant:"text",color:"primary",onClick:N},{default:a(()=>t[15]||(t[15]=[C("مسح البيانات والبدء من جديد")])),_:1})])]),_:1})):O("",!0)]),_:1}),e(le,null,{default:a(()=>[e(U,{cols:"12"},{default:a(()=>[l("div",rl,[e(b,{icon:"ri-information-line"}),t[17]||(t[17]=l("span",null,"المعلومات الأساسية",-1))]),e(oe,{class:"mb-4"})]),_:1}),e(U,{cols:"12",md:"6"},{default:a(()=>[e(X,{modelValue:i.value.phone,"onUpdate:modelValue":t[2]||(t[2]=d=>i.value.phone=d),label:"رقم الهاتف *",rules:[n(te),n(Ye)],"prepend-inner-icon":"ri-phone-line",loading:V.value==="phone",onBlur:t[3]||(t[3]=d=>q("phone")),disabled:g.isEditMode},{"append-inner":a(()=>[D.value.phone?(u(),x(b,{key:0,icon:"ri-checkbox-circle-fill",color:"success"})):O("",!0)]),_:1},8,["modelValue","rules","loading","disabled"])]),_:1}),e(U,{cols:"12",md:"6"},{default:a(()=>[e(X,{modelValue:i.value.email,"onUpdate:modelValue":t[4]||(t[4]=d=>i.value.email=d),label:"البريد الإلكتروني",type:"email",rules:[n(Xe)],"prepend-inner-icon":"ri-mail-line",loading:V.value==="email",onBlur:t[5]||(t[5]=d=>q("email")),disabled:g.isEditMode},{"append-inner":a(()=>[D.value.email?(u(),x(b,{key:0,icon:"ri-checkbox-circle-fill",color:"success"})):O("",!0)]),_:1},8,["modelValue","rules","loading","disabled"])]),_:1}),e(U,{cols:"12",md:"6"},{default:a(()=>[e(X,{modelValue:i.value.full_name,"onUpdate:modelValue":t[6]||(t[6]=d=>i.value.full_name=d),label:"الاسم الكامل *",rules:[n(te)],"prepend-inner-icon":"ri-user-follow-line"},null,8,["modelValue","rules"])]),_:1}),e(U,{cols:"12",md:"6"},{default:a(()=>[e(X,{modelValue:i.value.nickname,"onUpdate:modelValue":t[7]||(t[7]=d=>i.value.nickname=d),label:"الاسم المختصر (اللقب) *",rules:[n(te)],"prepend-inner-icon":"ri-user-star-line"},null,8,["modelValue","rules"])]),_:1}),e(U,{cols:"12",md:"6"},{default:a(()=>[e(X,{modelValue:i.value.username,"onUpdate:modelValue":t[8]||(t[8]=d=>i.value.username=d),label:"اسم المستخدم (Username)",rules:[],"prepend-inner-icon":"ri-at-line"},null,8,["modelValue"])]),_:1}),e(U,{cols:"12",md:"6"},{default:a(()=>[e(me,{modelValue:i.value.role,"onUpdate:modelValue":t[9]||(t[9]=d=>i.value.role=d),items:J.value,label:"الدور الوظيفي","prepend-inner-icon":"ri-shield-user-line",variant:"outlined",density:"comfortable"},null,8,["modelValue","items"])]),_:1}),i.value.id?O("",!0):(u(),x(U,{key:0,cols:"12",class:"mt-4"},{default:a(()=>[l("div",dl,[e(b,{icon:"ri-lock-password-line"}),t[18]||(t[18]=l("span",null,"الأمان والحالة",-1))]),e(oe,{class:"mb-4"})]),_:1})),i.value.id?O("",!0):(u(),x(U,{key:1,cols:"12",md:"6"},{default:a(()=>[e(X,{modelValue:i.value.password,"onUpdate:modelValue":t[10]||(t[10]=d=>i.value.password=d),label:g.isEditMode?"كلمة المرور (اتركها فارغة للتخطي)":"كلمة المرور *",type:"text",rules:g.isEditMode?[]:[n(te),n(Ze)(8)],"prepend-inner-icon":"ri-lock-line"},null,8,["modelValue","label","rules"])]),_:1})),e(U,{cols:"12",md:"6"},{default:a(()=>[e(H,{variant:"tonal",color:i.value.is_active?"success":"error",class:"pa-2 rounded-lg d-flex align-center justify-space-between",height:"56"},{default:a(()=>[l("span",ul,y(i.value.is_active?"المستخدم نشط":"المستخدم معطل"),1),e(Qe,{modelValue:i.value.is_active,"onUpdate:modelValue":t[11]||(t[11]=d=>i.value.is_active=d),"hide-details":""},null,8,["modelValue"])]),_:1},8,["color"])]),_:1})]),_:1}),l("div",cl,[e(pe,{variant:"tonal",color:"grey",onClick:t[12]||(t[12]=d=>v.$emit("cancel"))},{default:a(()=>t[19]||(t[19]=[C("إلغاء")])),_:1}),e(pe,{loading:z.value,color:"primary",class:"px-8 font-weight-bold rounded-pill",onClick:R},{default:a(()=>[e(b,{icon:i.value.id?"ri-user-received-line":"ri-save-line",class:"me-2"},null,8,["icon"]),C(" "+y(g.isEditMode?"تحديث البيانات":i.value.id?"ربط الحساب":"إنشاء المستخدم"),1)]),_:1},8,["loading"])]),e(Je,{modelValue:M.value,"onUpdate:modelValue":t[13]||(t[13]=d=>M.value=d),type:"avatar",onSelect:A},null,8,["modelValue"])]),_:1},512)]))}},pl=we(ml,[["__scopeId","data-v-ff7201eb"]]),fl={class:"glass-header d-flex align-center justify-space-between pa-6"},vl={class:"d-flex align-center gap-4"},gl={class:"text-h5 font-weight-bold text-white"},yl={class:"header-text"},hl={class:"d-flex align-center gap-2 mt-1"},xl={class:"text-subtitle-1 text-white opacity-90"},bl={class:"main-layout-wrapper d-flex"},_l={class:"nav-rail-glass py-6"},wl={class:"nav-rail-content d-flex flex-column gap-4 px-3"},kl={class:"d-flex flex-column align-center gap-2"},Vl={class:"text-caption font-weight-bold"},Cl={class:"flex-grow-1 content-glass-bg"},Ul={class:"d-flex flex-column h-100"},$l={class:"flex-grow-1 overflow-y-auto pa-6"},zl={class:"section-banner pa-6 rounded-xl mb-6 elevation-1 overflow-hidden"},Pl={class:"d-flex align-center justify-space-between relative-z"},Ml={class:"d-flex align-start gap-3"},Sl={class:"flex-grow-1"},jl={class:"d-flex align-center justify-space-between mb-1"},Il={class:"font-weight-black text-body-1"},El={class:"text-caption text-grey-darken-1 mb-2 line-clamp-2"},Ol={class:"d-flex gap-2"},Bl={class:"d-flex flex-column h-100"},Ll={class:"permissions-toolbar-glass px-6 py-4 border-b"},Al={class:"flex-grow-1 overflow-y-auto pa-6"},Dl={class:"permission-group-premium rounded-xl overflow-hidden elevation-1 bg-white mb-6"},Fl={class:"group-header pa-4 d-flex align-center justify-space-between border-b bg-grey-lighten-5"},Rl={class:"d-flex align-center gap-3"},Tl={class:"font-weight-black text-subtitle-2"},Gl={class:"text-caption text-grey"},Nl={key:1,class:"h-100 d-flex flex-column align-center justify-center py-12 opacity-40"},ql={class:"glass-footer pa-4 d-flex align-center justify-space-between"},Wl={class:"d-flex align-center gap-2 text-grey-darken-1"},Hl={class:"d-flex gap-3"},Jl={__name:"UserPermissionManager",props:{user:{type:Object,required:!0}},emits:["save","cancel"],setup(g,{emit:c}){const P=g,L=c,_=ne(),B=I(!1),z=I("roles"),M=I(!1),$=I(""),V=I([]),w=I([]),D=G(()=>[{label:"الأدوار",value:"roles",icon:"ri-shield-user-line",activeIcon:"ri-shield-check-fill",count:V.value.length},{label:"الصلاحيات",value:"permissions",icon:"ri-key-2-line",activeIcon:"ri-key-fill",count:w.value.length}]);fe(async()=>{_.loading=!0;try{await Promise.all([_.fetchRoles(),_.fetchAvailablePermissions()]),V.value=P.user.roles||[],w.value=P.user.direct_permissions||[]}finally{_.loading=!1}});const q=()=>{const m=P.user.full_name||P.user.username||"User",s=m.trim().split(" ");return s.length>=2?(s[0][0]+s[s.length-1][0]).toUpperCase():m.substring(0,2).toUpperCase()},N=m=>V.value.includes(m),i=m=>{const s=V.value.indexOf(m);s>-1?V.value.splice(s,1):V.value.push(m)},J=G(()=>{const m=new Set;return V.value.forEach(s=>{const o=_.roles.find(h=>h.name===s);o&&o.permissions&&o.permissions.forEach(h=>m.add(h))}),m}),A=m=>J.value.has(m),R=G(()=>{const m={},s=$.value.toLowerCase();return Object.entries(_.availablePermissions).forEach(([o,h])=>{var F,K;const p={name:h.name};let k=!1;(K=(F=h.name)==null?void 0:F.label)!=null&&K.toLowerCase().includes(s)?(k=!0,Object.entries(h).forEach(([Q,Y])=>{Q!=="name"&&(p[Q]=Y)})):Object.entries(h).forEach(([Q,Y])=>{Q!=="name"&&(Y.label.toLowerCase().includes(s)||Y.key.toLowerCase().includes(s))&&(p[Q]=Y,k=!0)}),k&&(m[o]=p)}),m}),S=m=>({admin:"ri-admin-line",companies:"ri-community-line",users:"ri-user-settings-line",warehouses:"ri-home-gear-line",products:"ri-box-3-line",invoices:"ri-file-list-3-line",transactions:"ri-hand-coin-line",cash_boxes:"ri-safe-2-line"})[m]||"ri-folder-keyhole-line",v=m=>Object.entries(m).filter(([o])=>o!=="name").map(([,o])=>o.key).every(o=>w.value.includes(o)||A(o)),t=m=>{const s=Object.entries(m).filter(([h])=>h!=="name").map(([,h])=>h.key),o=v(m);s.forEach(h=>{if(A(h))return;const p=w.value.indexOf(h);o?p>-1&&w.value.splice(p,1):p===-1&&w.value.push(h)})},d=async()=>{B.value=!0;try{const m={roles:V.value,permissions:w.value};await _.updateUser(P.user.id,m),L("save")}catch(m){console.error("Failed to update permissions:",m)}finally{B.value=!1}};return(m,s)=>(u(),x(H,{class:"user-permission-manager-premium overflow-hidden",elevation:"0"},{default:a(()=>[l("div",fl,[l("div",vl,[e(W,{size:"64",class:"avatar-gradient elevation-4"},{default:a(()=>[l("span",gl,y(q()),1)]),_:1}),l("div",yl,[s[8]||(s[8]=l("h2",{class:"text-h5 font-weight-black text-white mb-0"},"إدارة صلاحيات الوصول",-1)),l("div",hl,[e(b,{icon:"ri-user-smile-line",size:"16",color:"white",class:"opacity-80"}),l("span",xl,y(g.user.full_name||g.user.username),1)])])]),e(T,{icon:"ri-close-line",variant:"tonal",color:"white",class:"close-btn-hover",onClick:s[0]||(s[0]=o=>m.$emit("cancel"))})]),l("div",bl,[l("div",_l,[l("div",wl,[(u(!0),E(Z,null,ee(D.value,o=>(u(),x(T,{key:o.value,active:z.value===o.value,color:z.value===o.value?"primary":"grey-darken-1",variant:"text",class:"nav-item-premium py-8 rounded-xl",block:"",onClick:h=>z.value=o.value},{default:a(()=>[l("div",kl,[e(b,{icon:z.value===o.value?o.activeIcon:o.icon,size:"28"},null,8,["icon"]),l("span",Vl,y(o.label),1),o.count?(u(),x(Me,{key:0,content:o.count,color:"primary",floating:"","offset-x":"-10","offset-y":"-10"},null,8,["content"])):O("",!0)])]),_:2},1032,["active","color","onClick"]))),128))])]),l("div",Cl,[e(Se,{modelValue:z.value,"onUpdate:modelValue":s[6]||(s[6]=o=>z.value=o),class:"content-window"},{default:a(()=>[e(he,{value:"roles",class:"h-100"},{default:a(()=>[l("div",Ul,[l("div",$l,[l("div",zl,[l("div",Pl,[s[9]||(s[9]=l("div",null,[l("h3",{class:"text-h6 font-weight-black primary--text mb-1"},"الأدوار الوظيفية"),l("p",{class:"text-body-2 text-grey-darken-1"},"حدد الأدوار التي تعكس مسؤوليات المستخدم في النظام")],-1)),e(ae,{color:"primary",variant:"flat",size:"large",class:"px-6 font-weight-bold"},{default:a(()=>[C(y(V.value.length)+" / "+y(n(_).roles.length)+" موزع ",1)]),_:1})]),s[10]||(s[10]=l("div",{class:"banner-circle shadow-accent"},null,-1))]),n(_).roles.length?(u(),x(le,{key:0,dense:"",class:"role-grid"},{default:a(()=>[(u(!0),E(Z,null,ee(n(_).roles,(o,h)=>(u(),x(U,{key:o.id,cols:"12",sm:"6",lg:"4"},{default:a(()=>[e(je,null,{default:a(({isHovering:p,props:k})=>[e(H,Ie({ref_for:!0},k,{variant:N(o.name)?"flat":"outlined",color:N(o.name)?"primary":"grey-lighten-2",class:["role-premium-card transition-all",{"selected-float":N(o.name),"hover-scale":p}],onClick:F=>i(o.name)}),{default:a(()=>[e(Ee,{class:"pa-4"},{default:a(()=>[l("div",Ml,[e(xe,{modelValue:V.value,"onUpdate:modelValue":s[1]||(s[1]=F=>V.value=F),value:o.name,color:"primary","hide-details":"",density:"compact",onClick:s[2]||(s[2]=ue(()=>{},["stop"]))},null,8,["modelValue","value"]),l("div",Sl,[l("div",jl,[l("span",Il,y(o.label||o.name),1)]),l("p",El,y(o.description||"لا يوجد وصف متاح"),1),l("div",Ol,[o.permissions_count?(u(),x(ae,{key:0,size:"x-small",variant:"tonal",color:"primary"},{default:a(()=>[e(b,{icon:"ri-key-fill",size:"10",class:"me-1"}),C(" "+y(o.permissions_count)+" صلاحية ",1)]),_:2},1024)):O("",!0)])])])]),_:2},1024)]),_:2},1040,["variant","color","class","onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1})):O("",!0)])])]),_:1}),e(he,{value:"permissions",class:"h-100"},{default:a(()=>[l("div",Bl,[l("div",Ll,[e(le,{dense:"",align:"center"},{default:a(()=>[e(U,{cols:"12",md:"7"},{default:a(()=>[e(Oe,{modelValue:$.value,"onUpdate:modelValue":s[3]||(s[3]=o=>$.value=o),placeholder:"ابحث عن صلاحية محددة...","prepend-inner-icon":"ri-search-2-line",variant:"solo",flat:"",density:"comfortable","hide-details":"",clearable:"",class:"premium-search-field","bg-color":"grey-lighten-4"},null,8,["modelValue"])]),_:1}),e(U,{cols:"12",md:"5"},{default:a(()=>[e(Be,{modelValue:M.value,"onUpdate:modelValue":s[4]||(s[4]=o=>M.value=o),mandatory:"",color:"primary",variant:"tonal",class:"w-100 expert-toggle-group",divided:""},{default:a(()=>[e(T,{value:!1,block:"",class:"flex-grow-1"},{default:a(()=>[e(b,{icon:"ri-filter-3-line",class:"me-2"}),s[11]||(s[11]=C(" المبسط "))]),_:1}),e(T,{value:!0,block:"",class:"flex-grow-1"},{default:a(()=>[e(b,{icon:"ri-magic-line",class:"me-2"}),s[12]||(s[12]=C(" الخبير "))]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1}),e(Le,null,{default:a(()=>[M.value?(u(),x(ce,{key:0,type:"info",variant:"tonal",density:"compact",class:"mt-4 rounded-xl text-caption border-none glass-alert-info"},{default:a(()=>[e(b,{icon:"ri-shield-flash-line",size:"16",class:"me-2"}),s[13]||(s[13]=l("strong",null,"وضع الخبير نشط:",-1)),s[14]||(s[14]=C(" يظهر الصلاحيات الموروثة من الأدوار لتمكين المراجعة الشاملة. "))]),_:1})):w.value.length>0?(u(),x(ce,{key:1,type:"success",variant:"tonal",density:"compact",class:"mt-4 rounded-xl text-caption border-none glass-alert-success"},{default:a(()=>[e(b,{icon:"ri-checkbox-circle-line",size:"16",class:"me-2"}),s[15]||(s[15]=C(" لديك ")),l("strong",null,y(w.value.length),1),s[16]||(s[16]=C(" صلاحية مباشرة مخصصة لهذا المستخدم. "))]),_:1})):O("",!0)]),_:1})]),l("div",Al,[Object.keys(R.value).length?(u(),x(le,{key:0},{default:a(()=>[(u(!0),E(Z,null,ee(R.value,(o,h)=>(u(),x(U,{key:h,cols:"12"},{default:a(()=>{var p;return[l("div",Dl,[l("div",Fl,[l("div",Rl,[e(W,{color:"primary",variant:"tonal",size:"36"},{default:a(()=>[e(b,{icon:S(h),size:"20"},null,8,["icon"])]),_:2},1024),l("div",null,[l("span",Tl,y(((p=o.name)==null?void 0:p.label)||h),1),l("div",Gl,y(Object.keys(o).length-1)+" صلاحية",1)])]),e(T,{size:"small",variant:"tonal",color:v(o)?"grey":"primary",onClick:k=>t(o)},{default:a(()=>[C(y(v(o)?"إلغاء الكل":"تحديد الكل"),1)]),_:2},1032,["color","onClick"])]),e(Ae,{density:"comfortable",class:"py-0"},{default:a(()=>[(u(!0),E(Z,null,ee(o,(k,F)=>(u(),E(Z,{key:F},[F!=="name"&&(M.value||!A(k.key))?(u(),E(Z,{key:0},[e(De,{class:"premium-perm-item px-4"},{prepend:a(()=>[e(xe,{modelValue:w.value,"onUpdate:modelValue":s[5]||(s[5]=K=>w.value=K),value:k.key,disabled:A(k.key),color:"primary","hide-details":""},null,8,["modelValue","value","disabled"])]),default:a(()=>[e(Fe,{class:"d-flex align-center gap-2"},{default:a(()=>[l("span",{class:Re([{"text-grey opacity-60 italic":A(k.key)},"font-weight-medium"])},y(k.label),3),A(k.key)?(u(),x(ae,{key:0,size:"x-small",color:"primary",variant:"tonal",class:"px-2 font-weight-bold"},{default:a(()=>s[17]||(s[17]=[C(" من الأدوار ")])),_:1})):O("",!0)]),_:2},1024),e(Te,{class:"text-caption opacity-40"},{default:a(()=>[C(y(k.key),1)]),_:2},1024)]),_:2},1024),(u(),x(oe,{key:"div-"+F,inset:""}))],64)):O("",!0)],64))),128))]),_:2},1024)])]}),_:2},1024))),128))]),_:1})):(u(),E("div",Nl,[e(b,{icon:"ri-search-eye-line",size:"100"}),s[18]||(s[18]=l("h4",{class:"text-h6 font-weight-bold mt-4"},"لا توجد صلاحيات تطابق بحثك",-1)),s[19]||(s[19]=l("p",{class:"text-body-2"},"حاول استخدام كلمات مفتاحية أخرى",-1))]))])])]),_:1})]),_:1},8,["modelValue"])])]),e(oe),l("div",ql,[l("div",Wl,[e(b,{icon:"ri-lock-2-line",size:"16"}),s[20]||(s[20]=l("span",{class:"text-caption"},"يتم تشفير وتأمين جميع تحديثات الصلاحيات فوراً",-1))]),l("div",Hl,[e(T,{variant:"text",color:"grey-darken-1",class:"font-weight-bold",onClick:s[7]||(s[7]=o=>m.$emit("cancel"))},{default:a(()=>s[21]||(s[21]=[C(" تجاهل ")])),_:1}),e(T,{color:"primary",size:"large",class:"px-8 font-weight-black elevation-2",loading:B.value,"prepend-icon":"ri-shield-flash-line",rounded:"xl",onClick:d},{default:a(()=>s[22]||(s[22]=[C(" تحديث الصلاحيات ")])),_:1},8,["loading"])])])]),_:1}))}},Ql=we(Jl,[["__scopeId","data-v-d1950ebd"]]),Yl=g=>g?g.split(" ").map(c=>c[0]).join("").toUpperCase().slice(0,2):"",Xl={class:"users-page"},Zl={class:"pa-4 d-flex align-center gap-4"},Kl={class:"text-h5 font-weight-bold primary--text"},ea={class:"pa-4 d-flex align-center gap-4"},la={class:"text-h5 font-weight-bold text-success"},aa={class:"pa-4 d-flex align-center gap-4"},sa={class:"text-h5 font-weight-bold text-warning"},ta={class:"pa-4 d-flex align-center gap-4"},oa={class:"text-h5 font-weight-bold text-error"},na={class:"pa-4 d-flex align-center gap-3 flex-wrap"},ia={class:"d-flex align-center py-2"},ra={key:1,class:"text-primary font-weight-bold text-subtitle-1"},da={class:"d-flex flex-column"},ua={class:"font-weight-bold text-body-1"},ca={class:"text-caption text-grey d-flex align-center gap-1"},ma={key:0,class:"d-flex align-center gap-1 text-body-2"},pa={class:"text-ltr"},fa={key:1,class:"text-caption text-grey italic"},va={class:"d-flex flex-wrap gap-1"},ga={key:0,class:"text-caption text-grey italic"},ya={class:"px-6 pb-6"},ja={__name:"UserList",setup(g){const c=ne(),P=Ge(),{users:L,loading:_,totalItems:B,formData:z,isEditMode:M,isOpen:$,close:V,showConfirm:w,confirmMessage:D,handleConfirm:q,handleCancel:N,isPermissionOpen:i,permissionUser:J,openPermissions:A,closePermissions:R,loadUsers:S,loadMore:v,saveUser:t,handleDelete:d,handleEdit:m,handleCreate:s}=sl(),o=async j=>{await t(j),V()},h=async()=>{R(),await S()},p=()=>{_.value||!L.value||L.value.length>=(B.value||0)||v()},k=[{title:"المستخدم",key:"name",sortable:!0},{title:"الهاتف",key:"phone",sortable:!0},{title:"الأدوار",key:"roles",sortable:!1},{title:"الحالة",key:"status",sortable:!0},{title:"تاريخ الإضافة",key:"created_at",sortable:!0},{title:"الإجراءات",key:"actions",sortable:!1,align:"end"}],F=[{title:"الكل",value:null},{title:"مدير عام",value:"admin.super"},{title:"مدير شركة",value:"admin.company"},{title:"موظف",value:"employee"}],K=[{title:"الكل",value:null},{title:"نشط",value:"active"},{title:"معطل",value:"inactive"}],Q=G(()=>{var j;return((j=c.stats)==null?void 0:j.active)||0}),Y=G(()=>{var j;return((j=c.stats)==null?void 0:j.admins)||0}),ke=G(()=>{var j;return((j=c.stats)==null?void 0:j.inactive)||0}),ie=()=>{c.page=1,S()},Ve=()=>{c.page=1,S()},Ce=j=>{c.sortBy=j.sortBy,S()},Ue=j=>{A(j)};return fe(()=>{c.page=1,S(!1),c.fetchStats()}),de(()=>c.search,()=>{c.page=1,S(!1)}),de(()=>c.itemsPerPage,()=>{c.page=1,S(!1)}),(j,f)=>{var ve,ge;const $e=X;return u(),E("div",Xl,[e(le,{class:"mb-6"},{default:a(()=>[e(U,{cols:"12",sm:"6",md:"3"},{default:a(()=>[e(H,{class:"rounded-xl border border-primary-lighten-4 elevation-sm overflow-hidden"},{default:a(()=>[l("div",Zl,[e(W,{color:"primary-lighten-5",rounded:"lg",size:"48"},{default:a(()=>[e(b,{icon:"ri-team-line",color:"primary"})]),_:1}),l("div",null,[f[11]||(f[11]=l("div",{class:"text-caption text-grey-darken-1 font-weight-medium"},"إجمالي المستخدمين",-1)),l("div",Kl,y(n(B)||0),1)])])]),_:1})]),_:1}),e(U,{cols:"12",sm:"6",md:"3"},{default:a(()=>[e(H,{class:"rounded-xl border border-success-lighten-4 elevation-sm overflow-hidden"},{default:a(()=>[l("div",ea,[e(W,{color:"success-lighten-5",rounded:"lg",size:"48"},{default:a(()=>[e(b,{icon:"ri-user-follow-line",color:"success"})]),_:1}),l("div",null,[f[12]||(f[12]=l("div",{class:"text-caption text-grey-darken-1 font-weight-medium"},"نشطين الآن",-1)),l("div",la,y(Q.value),1)])])]),_:1})]),_:1}),e(U,{cols:"12",sm:"6",md:"3"},{default:a(()=>[e(H,{class:"rounded-xl border border-warning-lighten-4 elevation-sm overflow-hidden"},{default:a(()=>[l("div",aa,[e(W,{color:"warning-lighten-5",rounded:"lg",size:"48"},{default:a(()=>[e(b,{icon:"ri-admin-line",color:"warning"})]),_:1}),l("div",null,[f[13]||(f[13]=l("div",{class:"text-caption text-grey-darken-1 font-weight-medium"},"المدراء",-1)),l("div",sa,y(Y.value),1)])])]),_:1})]),_:1}),e(U,{cols:"12",sm:"6",md:"3"},{default:a(()=>[e(H,{class:"rounded-xl border border-error-lighten-4 elevation-sm overflow-hidden"},{default:a(()=>[l("div",ta,[e(W,{color:"error-lighten-5",rounded:"lg",size:"48"},{default:a(()=>[e(b,{icon:"ri-user-forbid-line",color:"error"})]),_:1}),l("div",null,[f[14]||(f[14]=l("div",{class:"text-caption text-grey-darken-1 font-weight-medium"},"معطلين",-1)),l("div",oa,y(ke.value),1)])])]),_:1})]),_:1})]),_:1}),e(H,{class:"rounded-xl border border-grey-lighten-4 mb-6 elevation-sm overflow-visible"},{default:a(()=>[l("div",na,[e($e,{modelValue:n(c).search,"onUpdate:modelValue":[f[0]||(f[0]=r=>n(c).search=r),Ve],label:"بحث بالمستخدم...","prepend-inner-icon":"ri-search-line",density:"compact","hide-details":"",class:"max-width-300 flex-grow-1 flex-sm-grow-0"},null,8,["modelValue"]),e(me,{modelValue:n(c).roleFilter,"onUpdate:modelValue":[f[1]||(f[1]=r=>n(c).roleFilter=r),ie],items:F,label:"الدور",density:"compact","hide-details":"",clearable:"",class:"max-width-200"},null,8,["modelValue"]),e(me,{modelValue:n(c).statusFilter,"onUpdate:modelValue":[f[2]||(f[2]=r=>n(c).statusFilter=r),ie],items:K,label:"الحالة",density:"compact","hide-details":"",clearable:"",class:"max-width-200"},null,8,["modelValue"]),n(P).isAdmin?(u(),x(qe,{key:0,modelValue:n(c).isGlobalMode,"onUpdate:modelValue":[f[3]||(f[3]=r=>n(c).isGlobalMode=r),ie],label:"عرض عالمي",color:"primary","hide-details":"",inset:"",density:"compact",class:"ml-4"},null,8,["modelValue"])):O("",!0),e(We),e(pe,{color:"primary","prepend-icon":"ri-user-add-line",class:"font-weight-bold rounded-pill",onClick:n(s)},{default:a(()=>f[15]||(f[15]=[C(" مستخدم جديد ")])),_:1},8,["onClick"])])]),_:1}),e(ll,{loading:n(_)&&((ve=n(L))==null?void 0:ve.length)>0,"has-more":(((ge=n(L))==null?void 0:ge.length)||0)<(n(B)||0),"no-more-text":"لا يوجد المزيد من المستخدمين",onLoad:p},{default:a(()=>[e(Ke,{page:n(c).page,"onUpdate:page":f[4]||(f[4]=r=>n(c).page=r),"items-per-page":n(c).itemsPerPage,"onUpdate:itemsPerPage":f[5]||(f[5]=r=>n(c).itemsPerPage=r),"sort-by":n(c).sortBy,"onUpdate:sortBy":f[6]||(f[6]=r=>n(c).sortBy=r),headers:k,items:n(L)||[],"total-items":n(B)||0,loading:n(_),"hide-pagination":"","onUpdate:options":Ce,onEdit:n(m),onDelete:n(d)},{"item.name":a(({item:r})=>[l("div",ia,[e(W,{size:"45",color:r.avatar_url?void 0:"primary-lighten-5",class:"me-3 border shadow-sm overflow-hidden"},{default:a(()=>[r.avatar_url?(u(),x(_e,{key:0,src:r.avatar_url,cover:""},null,8,["src"])):(u(),E("span",ra,y(n(Yl)(r.nickname||r.full_name)),1))]),_:2},1032,["color"]),l("div",da,[l("span",ua,y(r.nickname||r.full_name),1),l("span",ca,[e(b,{icon:"ri-mail-line",size:"12"}),C(" "+y(r.email||"لا يوجد بريد"),1)])])])]),"item.phone":a(({item:r})=>[r.phone?(u(),E("div",ma,[e(b,{icon:"ri-phone-line",size:"14",color:"primary"}),l("span",pa,y(r.phone),1)])):(u(),E("span",fa,"لا يوجد"))]),"item.roles":a(({item:r})=>{var re;return[l("div",va,[(u(!0),E(Z,null,ee(r.roles,ye=>(u(),x(ae,{key:ye,size:"x-small",variant:"flat",color:"secondary-lighten-5",class:"text-secondary font-weight-bold px-2 rounded"},{default:a(()=>[C(y(ye),1)]),_:2},1024))),128)),(re=r.roles)!=null&&re.length?O("",!0):(u(),E("span",ga,"موظف"))])]}),"item.status":a(({item:r})=>[e(ae,{color:r.status==="active"||r.status===1?"success":"error",size:"x-small",variant:"flat",class:"font-weight-bold px-2"},{default:a(()=>[C(y(r.status==="active"||r.status===1?"نشط":"معطل"),1)]),_:2},1032,["color"])]),"extra-actions":a(({item:r})=>[e(T,{icon:"ri-shield-user-line",size:"small",variant:"text",color:"warning",tooltip:"إدارة الصلاحيات",onClick:re=>Ue(r)},null,8,["onClick"])]),_:1},8,["page","items-per-page","sort-by","items","total-items","loading","onEdit","onDelete"])]),_:1},8,["loading","has-more"]),l("div",ya,[e(al,{modelValue:n(w),"onUpdate:modelValue":f[7]||(f[7]=r=>se(w)?w.value=r:null),message:n(D),onConfirm:n(q),onCancel:n(N)},null,8,["modelValue","message","onConfirm","onCancel"])]),e(el,{modelValue:n($),"onUpdate:modelValue":f[9]||(f[9]=r=>se($)?$.value=r:null),title:n(M)?"تعديل بيانات المستخدم":"إضافة مستخدم جديد",icon:n(M)?"ri-user-edit-line":"ri-user-add-line","max-width":"800","hide-actions":""},{default:a(()=>[e(pl,{modelValue:n(z),"onUpdate:modelValue":f[8]||(f[8]=r=>se(z)?z.value=r:null),"is-edit-mode":n(M),onSave:o,onCancel:n(V)},null,8,["modelValue","is-edit-mode","onCancel"])]),_:1},8,["modelValue","title","icon"]),e(Ne,{modelValue:n(i),"onUpdate:modelValue":f[10]||(f[10]=r=>se(i)?i.value=r:null),"max-width":"900",scrollable:"",transition:"dialog-bottom-transition"},{default:a(()=>[n(i)?(u(),x(Ql,{key:0,user:n(J),onSave:h,onCancel:n(R)},null,8,["user","onCancel"])):O("",!0)]),_:1},8,["modelValue"])])}}};export{ja as default};
