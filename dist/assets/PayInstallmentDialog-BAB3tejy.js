import{z as J,r as m,P as K,w as O,Z as Q,o as r,k as g,j as t,d as l,ap as $,V as v,b as d,a1 as B,c as b,az as ee,a as s,a2 as ae,a6 as M,aw as I,be as te,C as E,U as D,t as y,M as le,W as R,q as z,F as se,A as oe,as as ie,aq as ne,Y as de,a9 as W,X as re,aj as ue}from"./index-Tc2OuKZg.js";const me={key:0,class:"d-flex flex-column align-center justify-center py-10"},ve={class:"mb-4"},ce={class:"mb-4"},pe={class:"mb-4"},fe={class:"mb-4"},ye={key:2,class:"text-center py-4"},_e={class:"mb-4"},be={class:"d-flex align-center justify-space-between mb-2"},xe={class:"text-h6 font-weight-bold"},Ve={key:0,class:"mt-3"},ge={class:"text-body-2"},he={class:"font-weight-bold"},we={class:"text-start"},ke={class:"d-flex align-center mb-3"},Pe={key:0},Ce={class:"d-flex align-center justify-space-between"},Se={class:"d-flex align-center"},Be={class:"text-body-2 font-weight-bold"},De={class:"text-body-2 font-weight-medium"},ze={class:"text-caption text-medium-emphasis"},Ue={class:"text-left"},je={key:0},Fe={key:1},Le={__name:"PayInstallmentDialog",props:{installment:Object,modelValue:Boolean,directPay:{type:Boolean,default:!0}},emits:["update:modelValue","update:installment"],setup(k,{emit:X}){const P=J(),c=k,U=X,_=m(!1),p=m(null),f=m(!1),C=m(!1),u=m(!1),n=m({amount:"",paid_at:new Date().toISOString().substr(0,10),payment_method_id:"",cash_box_id:null,notes:"",installment_ids:[]}),x=m([]),j=m([]),h=m(null),w=m(null);async function Y(){try{const{data:o}=await ue("payment-methods",{per_page:-1},!0,!1,!1);x.value=o||[]}catch(o){console.error("خطأ في جلب طرق الدفع:",o)}}async function Z(){var o,e;try{await P.fetchUser(),h.value=((o=P.user)==null?void 0:o.cash_box_id)||null,j.value=((e=P.user)==null?void 0:e.cashBoxes)||[]}catch(i){console.error("خطأ في جلب صناديق النقدية:",i)}}K(async()=>{await Promise.all([Y(),Z()]);const o=x.value.length>0,e=!!h.value,i=c.installment;i&&o&&e&&(F(i),c.directPay&&!u.value&&!f.value&&S())});function F(o){if(!o)return;n.value.installment_ids=[o.id],n.value.amount=o.remaining,n.value.user_id=o.user_id,n.value.installment_plan_id=o.installment_plan_id,n.value.notes="";const e=x.value.find(i=>{var V;return((V=i.code)==null?void 0:V.trim().toLowerCase())==="cash"});n.value.payment_method_id=(e==null?void 0:e.id)||"",n.value.cash_box_id=h.value}O(()=>c.installment,o=>{const e=x.value.length>0,i=!!h.value;o&&e&&i&&(F(o),c.directPay&&!u.value&&!f.value&&S())}),O(()=>c.modelValue,o=>{_.value=o,o&&c.installment&&!u.value&&(n.value.amount=c.installment.remaining||c.installment.amount),o||G()});function G(){n.value={amount:"",paid_at:new Date().toISOString().substr(0,10),payment_method_id:"",cash_box_id:null,notes:"",installment_ids:[]},u.value=!1,f.value=!1,p.value=null,w.value&&w.value.resetValidation()}function H(){U("update:modelValue",!1)}async function S(){var o,e;if(!c.directPay){const{valid:i}=await w.value.validate();if(!i)return}f.value=!0;try{const i=await Q("installment-payment/pay",n.value,!1,!1);p.value=i.data,u.value=!0,U("update:installment",i)}catch(i){console.error("خطأ في إرسال الدفع:",i),alert("حدث خطأ أثناء الدفع: "+(((e=(o=i.response)==null?void 0:o.data)==null?void 0:e.message)||i.message)),u.value=!1,p.value=null}finally{f.value=!1}}return(o,e)=>(r(),g(re,{modelValue:_.value,"onUpdate:modelValue":e[6]||(e[6]=i=>_.value=i),"max-width":"500px",persistent:""},{default:t(()=>[l(D,{class:"rounded-lg"},{default:t(()=>[l($,{class:"text-h5 pa-5 bg-primary"},{default:t(()=>[l(v,{start:"",class:"ml-2"},{default:t(()=>e[7]||(e[7]=[d("ri-wallet-3-line")])),_:1}),e[8]||(e[8]=d(" سداد القسط "))]),_:1}),l(B,{class:"pa-6"},{default:t(()=>{var i,V;return[_.value&&f.value?(r(),b("div",me,[l(ee,{indeterminate:"",color:"primary",size:"64",width:"6",class:"mb-4"}),e[9]||(e[9]=s("p",{class:"text-h6 text-medium-emphasis mb-2"},"جاري معالجة الدفع...",-1)),e[10]||(e[10]=s("p",{class:"text-body-2 text-medium-emphasis"},"الرجاء الانتظار",-1))])):_.value&&!f.value&&!u.value&&!k.directPay?(r(),g(ae,{key:1,ref_key:"payForm",ref:w,modelValue:C.value,"onUpdate:modelValue":e[5]||(e[5]=a=>C.value=a)},{default:t(()=>[s("div",ve,[l(M,{variant:"outlined",label:"مبلغ السداد",modelValue:n.value.amount,"onUpdate:modelValue":e[0]||(e[0]=a=>n.value.amount=a),type:"number",rules:[a=>!!a||"المبلغ مطلوب",a=>a>0||"المبلغ يجب أن يكون أكبر من صفر"],required:"",density:"comfortable",color:"primary"},{"prepend-inner":t(()=>[l(v,{color:"primary"},{default:t(()=>e[11]||(e[11]=[d("ri-money-dollar-circle-line")])),_:1})]),_:1},8,["modelValue","rules"])]),s("div",ce,[l(M,{variant:"outlined",label:"تاريخ السداد",modelValue:n.value.paid_at,"onUpdate:modelValue":e[1]||(e[1]=a=>n.value.paid_at=a),type:"date",density:"comfortable",color:"primary"},{"prepend-inner":t(()=>[l(v,{color:"primary"},{default:t(()=>e[12]||(e[12]=[d("ri-calendar-line")])),_:1})]),_:1},8,["modelValue"])]),s("div",pe,[l(I,{variant:"outlined",label:"طريقة الدفع",modelValue:n.value.payment_method_id,"onUpdate:modelValue":e[2]||(e[2]=a=>n.value.payment_method_id=a),items:x.value,"item-title":"name","item-value":"id",rules:[a=>!!a||"اختر طريقة الدفع"],required:"",density:"comfortable",color:"primary"},{"prepend-inner":t(()=>[l(v,{color:"primary"},{default:t(()=>e[13]||(e[13]=[d("ri-bank-card-line")])),_:1})]),_:1},8,["modelValue","items","rules"])]),s("div",fe,[l(I,{variant:"outlined",label:"صندوق النقدية",modelValue:n.value.cash_box_id,"onUpdate:modelValue":e[3]||(e[3]=a=>n.value.cash_box_id=a),items:j.value,"item-title":"name","item-value":"id",rules:[a=>!!a||"اختر صندوق النقدية"],density:"comfortable",color:"primary"},{"prepend-inner":t(()=>[l(v,{color:"primary"},{default:t(()=>e[14]||(e[14]=[d("ri-safe-line")])),_:1})]),_:1},8,["modelValue","items","rules"])]),s("div",null,[l(te,{variant:"outlined",label:"ملاحظات (اختياري)",modelValue:n.value.notes,"onUpdate:modelValue":e[4]||(e[4]=a=>n.value.notes=a),rows:"2",density:"comfortable",color:"primary","auto-grow":""},{"prepend-inner":t(()=>[l(v,{color:"primary"},{default:t(()=>e[15]||(e[15]=[d("ri-file-text-line")])),_:1})]),_:1},8,["modelValue"])])]),_:1},8,["modelValue"])):_.value&&!f.value&&u.value&&p.value?(r(),b("div",ye,[s("div",_e,[l(E,{size:"80",color:"success",class:"elevation-4"},{default:t(()=>[l(v,{size:"50",color:"white"},{default:t(()=>e[16]||(e[16]=[d("ri-checkbox-circle-fill")])),_:1})]),_:1})]),e[23]||(e[23]=s("h3",{class:"text-h5 mb-2 font-weight-bold"},"تمت العملية بنجاح!",-1)),e[24]||(e[24]=s("p",{class:"text-body-2 text-medium-emphasis mb-4"},"تم تسجيل الدفع في النظام",-1)),l(D,{variant:"tonal",color:"success",class:"mb-4"},{default:t(()=>[l(B,{class:"pa-4"},{default:t(()=>{var a,A,L,T;return[s("div",be,[e[17]||(e[17]=s("span",{class:"text-body-2"},"المبلغ المدفوع:",-1)),s("span",xe,y((A=(a=p.value)==null?void 0:a.payment_record)==null?void 0:A.amount_paid)+" ج.م ",1)]),(T=(L=p.value)==null?void 0:L.payment_record)!=null&&T.excess_amount?(r(),b("div",Ve,[l(le,{class:"mb-3"}),l(R,{type:"info",variant:"tonal",density:"compact",class:"text-start"},{default:t(()=>{var q,N;return[s("div",ge,[e[19]||(e[19]=s("div",{class:"font-weight-bold mb-1"},"مبلغ متبقٍ",-1)),s("div",null,[e[18]||(e[18]=d(" تم دفع جميع الأقساط المستحقة، ويوجد مبلغ متبقٍ بقيمة ")),s("span",he,y((N=(q=p.value)==null?void 0:q.payment_record)==null?void 0:N.excess_amount)+" ج.م ",1)])])]}),_:1})])):z("",!0)]}),_:1})]),_:1}),s("div",we,[s("div",ke,[l(v,{start:"",color:"primary"},{default:t(()=>e[20]||(e[20]=[d("ri-file-list-3-line")])),_:1}),e[21]||(e[21]=s("span",{class:"text-subtitle-1 font-weight-bold"},"الأقساط التي تم دفعها",-1))]),(V=(i=p.value)==null?void 0:i.paid_installments)!=null&&V.length?(r(),b("div",Pe,[(r(!0),b(se,null,oe(p.value.paid_installments,a=>(r(),g(D,{key:a.id,variant:"outlined",class:"mb-2"},{default:t(()=>[l(B,{class:"pa-3"},{default:t(()=>[s("div",Ce,[s("div",Se,[l(E,{size:"32",color:a.remaining!="0.00"?"warning":"success",class:"ml-3"},{default:t(()=>[s("span",Be,y(a.installment_number),1)]),_:2},1032,["color"]),s("div",null,[s("div",De,"قسط رقم "+y(a.installment_number),1),s("div",ze,y(a.due_date.split(" ")[0]),1)])]),s("div",Ue,[l(ie,{color:a.remaining!="0.00"?"warning":"success",size:"small",variant:"flat"},{default:t(()=>[l(v,{start:"",size:"16"},{default:t(()=>[d(y(a.remaining!="0.00"?"ri-time-line":"ri-check-line"),1)]),_:2},1024),a.remaining!="0.00"?(r(),b("span",je," باقي "+y(a.remaining)+" ج.م ",1)):(r(),b("span",Fe," مدفوع "+y(a.amount)+" ج.م ",1))]),_:2},1032,["color"])])])]),_:2},1024)]),_:2},1024))),128))])):(r(),g(R,{key:1,type:"info",variant:"tonal",density:"compact",class:"text-center"},{default:t(()=>e[22]||(e[22]=[d(" لا توجد أقساط مدفوعة لعرضها ")])),_:1}))])])):z("",!0)]}),_:1}),l(ne,{class:"pa-5 pt-0"},{default:t(()=>[l(de),l(W,{variant:"text",onClick:H,size:"large"},{default:t(()=>[d(y(u.value?"إغلاق":"إلغاء"),1)]),_:1}),_.value&&!f.value&&!u.value&&!k.directPay?(r(),g(W,{key:0,color:"primary",disabled:!C.value,onClick:S,size:"large",variant:"flat"},{default:t(()=>[l(v,{start:""},{default:t(()=>e[25]||(e[25]=[d("ri-check-line")])),_:1}),e[26]||(e[26]=d(" تأكيد الدفع "))]),_:1},8,["disabled"])):z("",!0)]),_:1})]),_:1})]),_:1},8,["modelValue"]))}};export{Le as _};
