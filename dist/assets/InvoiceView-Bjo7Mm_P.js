import{r as x,L as K,x as d,w as l,V as W,U as X,o,b as t,d as n,v as i,c,E as u,u as g,n as p,e as $,f as y,i as A,ai as Y,j as P,F as z,R as Z,D,O as I,af as tt,p as et,Q as st,A as lt,B as at,a4 as ot,a5 as nt}from"./index-B0c0aplS.js";import{u as it}from"./useApi-C9JqAxpT.js";import{u as rt}from"./usePermissions-D1W15K8H.js";import{u as ut}from"./usePrintExport-CFRwAj9b.js";import{_ as b}from"./AppButton-CoaWq9vh.js";import{_ as h}from"./AppCard-D6Bc5W2v.js";import{A as dt}from"./AppDialog-yMQfGMN-.js";import{_ as ct}from"./LoadingSpinner-DEhea3Ta.js";const pt={class:"d-flex align-center justify-space-between mb-6"},vt={class:"d-flex align-center"},mt={class:"text-h4 font-weight-bold"},ft={key:0,class:"text-body-1 text-grey"},yt={class:"d-flex gap-2 no-print"},_t={key:0,class:"d-flex justify-center align-center py-12"},xt={id:"invoice-content"},gt={class:"font-weight-bold text-h6"},bt={class:"font-weight-bold text-h6"},ht={class:"font-weight-medium"},wt={class:"font-weight-medium"},kt={class:"font-weight-bold"},Vt={key:0,class:"text-caption text-grey"},Ct={class:"text-center"},jt={class:"text-left text-body-2"},Dt={class:"text-left text-body-2 text-error"},It={class:"text-left font-weight-bold text-success"},Lt={key:1,class:"text-center py-6 text-grey"},St={class:"d-flex flex-column gap-4"},Bt={class:"d-flex flex-column gap-2 mb-4"},Et={class:"d-flex justify-space-between text-body-2"},$t={class:"font-weight-medium"},At={key:0,class:"d-flex justify-space-between text-body-2 text-error"},Pt={key:1,class:"d-flex justify-space-between text-body-2"},zt={key:2,class:"d-flex justify-space-between text-body-2"},Nt={class:"d-flex justify-space-between align-center mb-4"},Rt={class:"text-h5 font-weight-black text-success"},Ft={class:"d-flex flex-column gap-2 p-2 rounded-lg bg-grey-lighten-4"},Gt={class:"d-flex justify-space-between text-body-2"},Tt={class:"font-weight-bold text-info"},Ut={key:0,class:"d-flex justify-space-between text-body-2"},Mt={class:"font-weight-bold text-error"},Ot={key:1,class:"text-center text-success font-weight-bold py-1"},te={__name:"InvoiceView",setup(qt){const C=et(),w=X(),{can:_}=rt(),{printElement:N}=ut(),j=it("/api/invoices"),L=x(!0),s=x(null),k=x(!1),R=x(!1),V=x(null),F=[{title:"مسودة",value:"draft"},{title:"قيد الانتظار",value:"pending"},{title:"معتمدة",value:"approved"},{title:"ملغاة",value:"cancelled"}],G=()=>C.push("/invoices"),T=()=>C.push(`/invoices/${w.params.id}/edit`),U=()=>{var a;N("invoice-content",`فاتورة #${(a=s.value)==null?void 0:a.invoice_number}`)},M=async()=>{try{await j.remove(w.params.id,{successMessage:"تم حذف الفاتورة"}),C.push("/invoices")}finally{k.value=!1}},O=async a=>{try{await j.update(w.params.id,{status:a}),s.value.status=a}catch{V.value=s.value.status}},S=a=>a?new Date(a).toLocaleDateString("ar-EG"):"-",v=a=>a?new Intl.NumberFormat("ar-EG",{style:"currency",currency:"EGP"}).format(a):"0.00 ج.م",q=a=>({draft:"grey",pending:"warning",approved:"success",cancelled:"error"})[a]||"grey",Q=a=>({draft:"مسودة",pending:"قيد الانتظار",approved:"معتمدة",cancelled:"ملغاة"})[a]||a,H=a=>({unpaid:"error",partial:"warning",paid:"success"})[a]||"grey",J=a=>({unpaid:"غير مدفوعة",partial:"مدفوعة جزئياً",paid:"مدفوعة بالكامل"})[a]||a;return K(async()=>{try{const a=await j.getById(w.params.id);s.value=a.data,V.value=s.value.status}finally{L.value=!1}}),(a,e)=>(o(),d(W,{fluid:""},{default:l(()=>{var B;return[t("div",pt,[t("div",vt,[n(b,{icon:"ri-arrow-right-line",variant:"text",color:"secondary",onClick:G,class:"me-3"}),t("div",null,[t("h1",mt,"الفاتورة #"+i((B=s.value)==null?void 0:B.invoice_number),1),s.value?(o(),c("p",ft,i(S(s.value.invoice_date)),1)):u("",!0)])]),t("div",yt,[g(_)("invoices.update_all")?(o(),d(b,{key:0,color:"primary","prepend-icon":"ri-edit-line",onClick:T},{default:l(()=>e[4]||(e[4]=[p(" تعديل ")])),_:1})):u("",!0),g(_)("invoices.print")?(o(),d(b,{key:1,color:"info","prepend-icon":"ri-printer-line",onClick:U},{default:l(()=>e[5]||(e[5]=[p(" طباعة ")])),_:1})):u("",!0),g(_)("invoices.delete_all")?(o(),d(b,{key:2,color:"error","prepend-icon":"ri-delete-bin-line",onClick:e[0]||(e[0]=r=>k.value=!0)},{default:l(()=>e[6]||(e[6]=[p(" حذف ")])),_:1})):u("",!0)])]),L.value?(o(),c("div",_t,[n(ct)])):u("",!0),t("div",xt,[s.value?(o(),d($,{key:0},{default:l(()=>[n(y,{cols:"12",md:"8"},{default:l(()=>[n(h,{title:"معلومات العميل",icon:"ri-user-line",class:"mb-6"},{default:l(()=>[n($,null,{default:l(()=>{var r,m;return[n(y,{cols:"12",sm:"6"},{default:l(()=>{var f;return[e[7]||(e[7]=t("div",{class:"text-caption text-grey mb-1"},"الاسم الكامل",-1)),t("div",gt,i((f=s.value.customer)==null?void 0:f.name),1)]}),_:1}),n(y,{cols:"12",sm:"6"},{default:l(()=>{var f;return[e[8]||(e[8]=t("div",{class:"text-caption text-grey mb-1"},"رقم الهاتف",-1)),t("div",bt,[n(A,{icon:"ri-phone-line",size:"small",class:"me-1"}),p(" "+i((f=s.value.customer)==null?void 0:f.phone),1)])]}),_:1}),(r=s.value.customer)!=null&&r.email?(o(),d(y,{key:0,cols:"12",sm:"6"},{default:l(()=>[e[9]||(e[9]=t("div",{class:"text-caption text-grey mb-1"},"البريد الإلكتروني",-1)),t("div",ht,i(s.value.customer.email),1)]),_:1})):u("",!0),(m=s.value.customer)!=null&&m.address?(o(),d(y,{key:1,cols:"12",sm:"6"},{default:l(()=>[e[10]||(e[10]=t("div",{class:"text-caption text-grey mb-1"},"العنوان",-1)),t("div",wt,i(s.value.customer.address),1)]),_:1})):u("",!0)]}),_:1})]),_:1}),n(h,{title:"عناصر الفاتورة",icon:"ri-list-check-2",class:"mb-6"},{default:l(()=>[n(Y,null,{default:l(()=>[e[11]||(e[11]=t("thead",null,[t("tr",null,[t("th",{class:"text-right"},"المنتج"),t("th",{class:"text-center"},"الكمية"),t("th",{class:"text-left"},"السعر"),t("th",{class:"text-left"},"الخصم"),t("th",{class:"text-left font-weight-bold"},"الإجمالي")])],-1)),t("tbody",null,[(o(!0),c(z,null,P(s.value.items,r=>(o(),c("tr",{key:r.id},[t("td",null,[t("div",kt,i(r.product_name),1),r.variant_name?(o(),c("div",Vt,i(r.variant_name),1)):u("",!0)]),t("td",Ct,[n(D,{size:"small",variant:"tonal",color:"primary"},{default:l(()=>[p(i(r.quantity),1)]),_:2},1024)]),t("td",jt,i(v(r.unit_price)),1),t("td",Dt,i(r.discount_percentage)+"%",1),t("td",It,i(v(r.total)),1)]))),128))])]),_:1})]),_:1}),n(h,{title:"سجل المدفوعات",icon:"ri-history-line"},{actions:l(()=>[s.value.payment_status!=="paid"?(o(),d(b,{key:0,variant:"outlined","prepend-icon":"ri-add-line",size:"small",class:"no-print",onClick:e[1]||(e[1]=r=>R.value=!0)},{default:l(()=>e[12]||(e[12]=[p(" إضافة دفعة ")])),_:1})):u("",!0)]),default:l(()=>{var r;return[(r=s.value.payments)!=null&&r.length?(o(),d(Z,{key:0,class:"pa-0"},{default:l(()=>[(o(!0),c(z,null,P(s.value.payments,(m,f)=>(o(),d(st,{key:m.id,class:lt({"border-bottom":f<s.value.payments.length-1})},{prepend:l(()=>[n(at,{color:"success-lighten-5",size:"40",class:"me-3"},{default:l(()=>[n(A,{icon:"ri-money-dollar-circle-line",color:"success"})]),_:1})]),default:l(()=>[n(ot,{class:"font-weight-bold text-success"},{default:l(()=>[p(i(v(m.amount)),1)]),_:2},1024),n(nt,null,{default:l(()=>{var E;return[p(i(S(m.payment_date))+" - "+i((E=m.payment_method)==null?void 0:E.name),1)]}),_:2},1024)]),_:2},1032,["class"]))),128))]),_:1})):(o(),c("div",Lt,"لا توجد مدفوعات مسجلة لهذه الفاتورة."))]}),_:1})]),_:1}),n(y,{cols:"12",md:"4"},{default:l(()=>[n(h,{title:"الحالة والمتابعة",icon:"ri-settings-4-line",class:"mb-6"},{default:l(()=>[t("div",St,[t("div",null,[e[13]||(e[13]=t("div",{class:"text-caption text-grey mb-1"},"حالة الفاتورة العامة",-1)),n(D,{color:q(s.value.status),variant:"tonal",class:"px-4 font-weight-bold"},{default:l(()=>[p(i(Q(s.value.status)),1)]),_:1},8,["color"])]),t("div",null,[e[14]||(e[14]=t("div",{class:"text-caption text-grey mb-1"},"حالة تحصيل المبالغ",-1)),n(D,{color:H(s.value.payment_status),variant:"tonal",class:"px-4 font-weight-bold"},{default:l(()=>[p(i(J(s.value.payment_status)),1)]),_:1},8,["color"])]),g(_)("invoices.update_all")?(o(),d(I,{key:0,class:"no-print"})):u("",!0),g(_)("invoices.update_all")?(o(),d(tt,{key:1,modelValue:V.value,"onUpdate:modelValue":[e[2]||(e[2]=r=>V.value=r),O],items:F,label:"تغيير الحالة",variant:"outlined",density:"comfortable",class:"no-print mt-2","hide-details":""},null,8,["modelValue"])):u("",!0)])]),_:1}),n(h,{title:"الملخص المالي",icon:"ri-money-dollar-box-line"},{default:l(()=>[t("div",Bt,[t("div",Et,[e[15]||(e[15]=t("span",{class:"text-grey"},"المجموع الفرعي:",-1)),t("span",$t,i(v(s.value.subtotal)),1)]),s.value.discount_amount>0?(o(),c("div",At,[e[16]||(e[16]=t("span",null,"إجمالي الخصم:",-1)),t("span",null,"-"+i(v(s.value.discount_amount)),1)])):u("",!0),s.value.tax_amount>0?(o(),c("div",Pt,[e[17]||(e[17]=t("span",{class:"text-grey"},"إجمالي الضريبة:",-1)),t("span",null,i(v(s.value.tax_amount)),1)])):u("",!0),s.value.shipping_cost>0?(o(),c("div",zt,[e[18]||(e[18]=t("span",{class:"text-grey"},"تكلفة الشحن:",-1)),t("span",null,i(v(s.value.shipping_cost)),1)])):u("",!0)]),n(I,{class:"my-4"}),t("div",Nt,[e[19]||(e[19]=t("span",{class:"text-h6 font-weight-bold"},"إجمالي الفاتورة:",-1)),t("span",Rt,i(v(s.value.total)),1)]),n(I,{class:"mb-4"}),t("div",Ft,[t("div",Gt,[e[20]||(e[20]=t("span",{class:"text-grey"},"إجمالي المدفوع:",-1)),t("span",Tt,i(v(s.value.paid_amount)),1)]),s.value.remaining>0?(o(),c("div",Ut,[e[21]||(e[21]=t("span",{class:"text-grey"},"المبلغ المتبقي:",-1)),t("span",Mt,i(v(s.value.remaining)),1)])):(o(),c("div",Ot,"مدفوعة بالكامل"))])]),_:1})]),_:1})]),_:1})):u("",!0)]),n(dt,{modelValue:k.value,"onUpdate:modelValue":e[3]||(e[3]=r=>k.value=r),title:"تأكيد حذف الفاتورة",icon:"ri-delete-bin-line","confirm-color":"error","confirm-text":"حذف",onConfirm:M},{default:l(()=>e[22]||(e[22]=[p(" هل أنت متأكد من حذف هذه الفاتورة؟ لا يمكن التراجع عن هذا الإجراء وسيتم حذف الفاتورة وجميع المدفوعات المرتبطة بها نهائياً. ")])),_:1},8,["modelValue"])]}),_:1}))}};export{te as default};
