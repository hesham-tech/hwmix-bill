import{aw as ee,r as u,z as L,ax as C,s as x,ay as M,a as te,o as d,c as A,x as m,aa as E,w as o,d as i,h as Q,F as J,j as W,f as N,e as X,L as ae,b as r,u as V,n as B,v as h,D as le,i as R,E as U,O as ne,R as se,Q as oe,A as re,B as ie,a4 as ce,a5 as de}from"./index-B0c0aplS.js";import{u as ue,a as ye}from"./index-BYS7HmYU.js";import{A as me}from"./AppDataTable-DRQWa6GE.js";import{_ as q}from"./AppButton-CoaWq9vh.js";import{A as fe}from"./AppDialog-yMQfGMN-.js";import{_ as pe}from"./EmptyState-C-yGKIfM.js";import{f as F,a as G}from"./formatters-CKQiR5Fb.js";import"./usePermissions-D1W15K8H.js";const he=ee("installment",()=>{const t=u([]),k=u(null),w=u([]),g=u([]),n=u(!1),S=u(0),D=u(1),P=u(10),y=u(""),f=u([]),v=u(null),b=u(null),T=L(()=>{var a,e;return{page:D.value,per_page:P.value,search:y.value,status:v.value,customer_id:b.value,sort_by:((a=f.value[0])==null?void 0:a.key)||"",order:((e=f.value[0])==null?void 0:e.order)||"desc"}});async function _(){n.value=!0;try{const a=await C.getPlans(T.value,{showToast:!1});return t.value=a.data,S.value=a.total,a}catch(a){throw console.error("Error fetching plans:",a),a}finally{n.value=!1}}async function p(a){n.value=!0;try{const e=await C.getOne(a,{full:!0});return k.value=e.data[0],e.data[0]}catch(e){throw console.error("Error fetching plan:",e),e}finally{n.value=!1}}async function s(a){n.value=!0;try{const e=await C.createPlan(a);return await _(),x.success("تم إنشاء خطة التقسيط بنجاح"),e.data[0]}catch(e){throw console.error("Error creating plan:",e),x.error("فشل إنشاء خطة التقسيط - يرجى التحقق من البيانات"),e}finally{n.value=!1}}async function c(a,e){n.value=!0;try{const l=await C.updatePlan(a,e);return await _(),x.success("تم تحديث خطة التقسيط بنجاح"),l.data[0]}catch(l){throw console.error("Error updating plan:",l),l}finally{n.value=!1}}async function I(a){n.value=!0;try{await C.delete(a),await _(),x.success("تم حذف خطة التقسيط بنجاح")}catch(e){throw console.error("Error deleting plan:",e),e}finally{n.value=!1}}async function H(a=null){n.value=!0;try{const e=a?{installment_plan_id:a}:{},l=await C.getPayments(e,{showToast:!1});return w.value=l.data,l}catch(e){throw console.error("Error fetching payments:",e),e}finally{n.value=!1}}async function $(a){n.value=!0;try{const e=await C.createPayment(a);return x.success("تم تسجيل الدفعة بنجاح"),e.data[0]}catch(e){throw console.error("Error creating payment:",e),e}finally{n.value=!1}}async function O(a){n.value=!0;try{const e=await M.getByPayment(a,{showToast:!1});return g.value=e.data,e}catch(e){throw console.error("Error fetching payment details:",e),e}finally{n.value=!1}}async function j(a){n.value=!0;try{const e=await M.createDetail(a);return x.success("تم تسجيل تفاصيل الدفعة بنجاح"),e.data[0]}catch(e){throw console.error("Error creating payment detail:",e),e}finally{n.value=!1}}async function K(a,e){n.value=!0;try{await M.replaceDetail(a,e),x.success("تم تحديث تفاصيل الدفعة بنجاح")}catch(l){throw console.error("Error updating payment detail:",l),x.error("فشل التحديث - استخدم حذف وإعادة إنشاء"),l}finally{n.value=!1}}function Y(){v.value=null,b.value=null,y.value="",D.value=1}return{plans:t,currentPlan:k,payments:w,paymentDetails:g,loading:n,totalItems:S,page:D,itemsPerPage:P,search:y,sortBy:f,statusFilter:v,customerFilter:b,params:T,fetchPlans:_,fetchPlan:p,createPlan:s,updatePlan:c,deletePlan:I,fetchPayments:H,createPayment:$,fetchPaymentDetails:O,createPaymentDetail:j,updatePaymentDetail:K,resetFilters:Y}});function ge(){const t=he(),{isOpen:k,formData:w,isEditMode:g,open:n,close:S}=ue(),{showConfirm:D,confirmMessage:P,confirm:y,handleConfirm:f,handleCancel:v}=ye(),b=L(()=>t.plans),T=L(()=>t.payments),_=L(()=>t.loading),p=L(()=>t.totalItems),s=async()=>{await t.fetchPlans()};return{plans:b,payments:T,loading:_,totalItems:p,formData:w,isEditMode:g,isOpen:k,open:n,close:S,showConfirm:D,confirmMessage:P,handleConfirm:async()=>{await f(),await s()},handleCancel:v,loadPlans:s,loadPlan:async l=>await t.fetchPlan(l),savePlan:async l=>g.value?await t.updatePlan(w.value.id,l):await t.createPlan(l),handleDeletePlan:l=>{y("هل أنت متأكد من حذف خطة التقسيط؟",async()=>{await t.deletePlan(l.id)})},handleEditPlan:l=>{n(l)},handleCreatePlan:()=>{n({})},loadPayments:async(l=null)=>{await t.fetchPayments(l)},createPayment:async l=>await t.createPayment(l),loadPaymentDetails:async l=>await t.fetchPaymentDetails(l),createPaymentDetail:async l=>await t.createPaymentDetail(l),updatePaymentDetail:async(l,Z)=>await t.updatePaymentDetail(l,Z)}}const ve={class:"app-skeleton"},we={__name:"AppSkeleton",props:{type:{type:String,default:"card",validator:t=>["table","card","list","form","article","dashboard","custom"].includes(t)},loading:{type:Boolean,default:!0},count:{type:Number,default:4},skeletonType:{type:String,default:"card"}},setup(t){return(k,w)=>(d(),A("div",ve,[t.type==="table"?(d(),m(E,{key:0,type:"table-heading, table-row-divider@3",loading:t.loading},null,8,["loading"])):t.type==="card"?(d(),m(Q,{key:1},{default:o(()=>[i(E,{type:"card",loading:t.loading},null,8,["loading"])]),_:1})):t.type==="list"?(d(),m(E,{key:2,type:"list-item-avatar-three-line@3",loading:t.loading},null,8,["loading"])):t.type==="form"?(d(),m(E,{key:3,type:"card-heading, list-item@3, actions",loading:t.loading},null,8,["loading"])):t.type==="article"?(d(),m(E,{key:4,type:"article, actions",loading:t.loading},null,8,["loading"])):t.type==="dashboard"?(d(),m(X,{key:5},{default:o(()=>[(d(!0),A(J,null,W(t.count,g=>(d(),m(N,{key:g,cols:"12",md:"6",lg:"3"},{default:o(()=>[i(Q,null,{default:o(()=>[i(E,{type:"card"})]),_:1})]),_:2},1024))),128))]),_:1})):(d(),m(E,{key:6,type:t.skeletonType,loading:t.loading},null,8,["type","loading"]))]))}},Pe=te(we,[["__scopeId","data-v-20871f58"]]),z={CASH:"cash",CARD:"card",TRANSFER:"transfer",CHECK:"check"},be={[z.CASH]:"نقدي",[z.CARD]:"بطاقة",[z.TRANSFER]:"تحويل",[z.CHECK]:"شيك"},_e={class:"installment-payments-page"},xe={class:"px-6 pb-6"},ke={class:"font-weight-black text-h6 text-success"},De={class:"font-weight-medium text-body-1"},Ce={class:"text-caption text-grey text-truncate d-inline-block",style:{"max-width":"200px"}},Ee={class:"d-flex justify-end"},Ve={key:0},Ae={class:"pa-3 border rounded-lg bg-grey-lighten-5 mb-2"},Se={class:"text-h5 font-weight-black text-success"},Te={class:"pa-3 border rounded-lg bg-grey-lighten-5 mb-2"},Ie={class:"text-h6 font-weight-bold"},Le={class:"pa-3 border rounded-lg bg-grey-lighten-5 mb-4"},Ne={class:"d-flex align-center"},Be={class:"font-weight-bold"},ze={class:"pa-3 border rounded-lg bg-grey-lighten-5 mb-4"},Me={class:"text-body-2"},Re={class:"d-flex align-center mb-4"},Fe={key:0,class:"py-12"},He={key:1},$e={class:"text-primary text-caption font-weight-bold"},Oe={class:"text-h6 font-weight-black text-primary"},We={__name:"InstallmentPaymentList",props:{planId:{type:[Number,String],default:null}},setup(t){const k=t,{payments:w,loading:g,loadPayments:n,loadPaymentDetails:S}=ge(),D=[{title:"المبلغ",key:"amount",sortable:!0},{title:"التاريخ",key:"date",sortable:!0},{title:"الطريقة",key:"method",sortable:!1},{title:"ملاحظات",key:"notes",sortable:!1},{title:"الإجراءات",key:"actions",sortable:!1}],P=u(!1),y=u(null),f=u([]),v=u(!1),b=p=>be[p]||p,T=async p=>{y.value=p,P.value=!0,v.value=!0;try{const s=await S(p.id);f.value=s.data}finally{v.value=!1}},_=()=>{console.log("Add payment")};return ae(()=>{n(k.planId)}),(p,s)=>(d(),A("div",_e,[r("div",xe,[i(me,{headers:D,items:V(w),loading:V(g),title:`سجل دفعات الخطة #${t.planId||"العامة"}`,icon:"ri-money-dollar-box-line"},{actions:o(()=>[i(q,{color:"primary","prepend-icon":"ri-add-line",onClick:_},{default:o(()=>s[1]||(s[1]=[B(" تسجيل دفعة جديدة ")])),_:1})]),"item.amount":o(({item:c})=>[r("div",ke,h(V(F)(c.amount)),1)]),"item.date":o(({item:c})=>[r("div",De,h(V(G)(c.date)),1)]),"item.method":o(({item:c})=>[i(le,{size:"small",variant:"flat",color:"primary-lighten-5",class:"text-primary font-weight-bold px-3"},{default:o(()=>[i(R,{icon:"ri-wallet-line",size:"14",class:"me-1"}),B(" "+h(b(c.method)),1)]),_:2},1024)]),"item.notes":o(({item:c})=>[r("span",Ce,h(c.notes||"---"),1)]),"item.actions":o(({item:c})=>[r("div",Ee,[i(q,{icon:"ri-eye-line",size:"x-small",variant:"text",color:"info",tooltip:"عرض التفاصيل الكاملة",onClick:I=>T(c)},null,8,["onClick"])])]),_:1},8,["items","loading","title"])]),i(fe,{modelValue:P.value,"onUpdate:modelValue":s[0]||(s[0]=c=>P.value=c),title:"تفاصيل دفعة القسط",icon:"ri-information-line","max-width":"600","hide-confirm":""},{default:o(()=>[y.value?(d(),A("div",Ve,[i(X,{dense:""},{default:o(()=>[i(N,{cols:"12",sm:"6"},{default:o(()=>[r("div",Ae,[s[2]||(s[2]=r("div",{class:"text-caption text-grey mb-1"},"قيمة الدفعة",-1)),r("div",Se,h(V(F)(y.value.amount)),1)])]),_:1}),i(N,{cols:"12",sm:"6"},{default:o(()=>[r("div",Te,[s[3]||(s[3]=r("div",{class:"text-caption text-grey mb-1"},"تاريخ العملية",-1)),r("div",Ie,h(V(G)(y.value.date)),1)])]),_:1}),i(N,{cols:"12"},{default:o(()=>[r("div",Le,[s[4]||(s[4]=r("div",{class:"text-caption text-grey mb-1"},"طريقة الدفع",-1)),r("div",Ne,[i(R,{icon:"ri-wallet-line",size:"small",class:"me-2"}),r("span",Be,h(b(y.value.method)),1)])])]),_:1}),y.value.notes?(d(),m(N,{key:0,cols:"12"},{default:o(()=>[r("div",ze,[s[5]||(s[5]=r("div",{class:"text-caption text-grey mb-1"},"ملاحظات إضافية",-1)),r("div",Me,h(y.value.notes),1)])]),_:1})):U("",!0)]),_:1}),i(ne,{class:"my-4"}),r("div",Re,[i(R,{icon:"ri-list-check-line",size:"small",color:"primary",class:"me-2"}),s[6]||(s[6]=r("h4",{class:"text-subtitle-1 font-weight-bold"},"توزيع الدفعة على الأقساط",-1))]),v.value?(d(),A("div",Fe,[i(Pe,{type:"list"})])):f.value.length?(d(),A("div",He,[i(se,{border:"",class:"rounded-lg pa-0 overflow-hidden"},{default:o(()=>[(d(!0),A(J,null,W(f.value,(c,I)=>(d(),m(oe,{key:c.id,class:re({"border-b":I<f.value.length-1})},{prepend:o(()=>[i(ie,{color:"primary-lighten-5",size:"32",class:"me-3"},{default:o(()=>[r("span",$e,"#"+h(c.installment_id),1)]),_:2},1024)]),append:o(()=>[r("div",Oe,h(V(F)(c.amount_paid)),1)]),default:o(()=>[i(ce,{class:"font-weight-bold"},{default:o(()=>s[7]||(s[7]=[B("قسط مستحق")])),_:1}),i(de,{class:"text-grey"},{default:o(()=>s[8]||(s[8]=[B("تم سداد جزء من قيمة القسط")])),_:1})]),_:2},1032,["class"]))),128))]),_:1})])):(d(),m(pe,{key:2,title:"لا توجد تفاصيل لتوزيع هذه الدفعة",icon:"ri-error-warning-line"}))])):U("",!0)]),_:1},8,["modelValue"])]))}};export{We as default};
