import{A as Se}from"./AppAvatar-ChqoPQpK.js";import{_ as Q}from"./AppInput-CufQk24k.js";import{z as L,a as _e,y as we,r as z,L as fe,aC as Me,K as ue,o as m,c as O,d as e,w as a,b as l,B as X,x as g,C as Ae,i as x,H as G,l as ce,at as je,aj as me,n as k,E as C,e as ae,f as w,O as se,u as i,af as oe,h as q,v,k as Ee,F as Y,j as le,aD as Ie,aE as Oe,aF as he,D as te,aq as Be,M as De,a3 as Le,a8 as xe,ao as Fe,aG as Re,aH as Ge,R as Te,Q as Ne,a4 as qe,A as He,a5 as Je,ag as ne,aI as We,ap as Qe,P as Ye}from"./index-98ieInin.js";import{u as ie}from"./user.store-Dse4wz8q.js";import{u as Xe}from"./usePermissions-DCdnT4T8.js";import{u as be,a as Ze}from"./index-DcLYFiI3.js";import{M as Ke}from"./MediaGallery-0pf_a0_o.js";import{A as el}from"./AppSwitch-CQy3Q7Sy.js";import{A as ll}from"./AppPasswordInput-BjniBbvH.js";import{_ as pe}from"./AppButton-Dj4u5ybH.js";import{r as ee,p as al,e as sl,m as tl}from"./validators-CndBNb9f.js";import{A as nl}from"./AppDataTable-DIGlqrRe.js";import{A as ol}from"./AppDialog-vdoPX15g.js";import{A as il}from"./AppInfiniteScroll-DpAEHV3t.js";import{C as rl}from"./ConfirmDialog-sTO8VDsi.js";/* empty css                                                                  */import"./useApi-C-2zrNsN.js";function dl(){const y=ie(),{isOpen:T,formData:u,isEditMode:N,open:h,close:P}=be(),{isOpen:U,formData:M,open:j,close:b}=be(),{showConfirm:_,confirmMessage:S,confirm:F,handleConfirm:B,handleCancel:D}=Ze(),E=L(()=>y.users),I=L(()=>y.loading),r=L(()=>y.totalItems),R=async(s=!1)=>{await y.fetchUsers({append:s})};return{users:E,loading:I,totalItems:r,formData:u,isEditMode:N,isOpen:T,open:h,close:P,showConfirm:_,confirmMessage:S,handleConfirm:async()=>{await B(),await R()},handleCancel:D,isPermissionOpen:U,permissionUser:M,openPermissions:j,closePermissions:b,loadUsers:R,loadMore:async()=>{I.value||!E.value||E.value.length>=(r.value||0)||(y.page++,await R(!0))},loadUser:async s=>await y.fetchUser(s),saveUser:async s=>N.value?await y.updateUser(u.value.id,s):await y.createUser(s),handleDelete:s=>{const V=s.nickname||s.full_name||s.name||"هذا المستخدم";F(`هل أنت متأكد من حذف المستخدم "${V}"؟`,async()=>{await y.deleteUser(s.id)})},handleEdit:s=>{h(s)},handleCreate:()=>{h({})},assignRole:async(s,V)=>{await y.assignRole(s,V)},updatePermissions:async(s,V)=>{await y.updatePermissions(s,V)}}}const ul={class:"user-form-container"},cl={class:"d-flex justify-center mb-8"},ml={class:"change-overlay d-flex flex-column align-center justify-center"},pl={class:"d-flex align-center justify-space-between flex-wrap gap-2"},fl={class:"d-flex align-center gap-2 mb-2 text-primary font-weight-bold"},vl={class:"d-flex align-center gap-2 mb-2 text-warning font-weight-bold"},gl={class:"ms-2 font-weight-bold"},yl={class:"d-flex align-center gap-2 mb-2 text-info font-weight-bold"},hl={class:"d-flex justify-end gap-3 mt-8"},xl={__name:"UserForm",props:{modelValue:{type:Object,default:()=>({})},isEditMode:{type:Boolean,default:!1}},emits:["save","cancel"],setup(y,{emit:T}){var p,n,o;const u=y,N=T,h=ie(),P=we(),U=z(null),M=z(!1),j=z(!1),b=z(!1),_=z([]),S=z(((p=u.modelValue)==null?void 0:p.avatar_url)||null),F=z(null),B=z(null),D=z({phone:!1,email:!1}),E=async d=>{const t=r.value[d];if(!(!t||t.length<3)&&!(d==="email"&&!t.includes("@"))&&!(d==="phone"&&t.length<8)){F.value=d;try{const s=await h.lookupUser({[d]:t});s&&typeof s=="object"&&Object.keys(s).length>0?(B.value=s,D.value[d]=!0,r.value.id=s.id,r.value.first_name=s.first_name||r.value.first_name,r.value.last_name=s.last_name||r.value.last_name,r.value.nickname=s.nickname||r.value.nickname,r.value.username=s.username||r.value.username,r.value.email=s.email||r.value.email,r.value.phone=s.phone||r.value.phone,s.avatar_url&&(S.value=s.avatar_url)):(B.value=null,D.value[d]=!0)}catch(s){console.error("Lookup failed:",s)}finally{F.value=null}}},I=()=>{r.value={first_name:"",last_name:"",nickname:"",username:"",email:"",phone:"",password:"",role:"sales",is_active:!0,address:"",notes:"",images_ids:[]},S.value=null,B.value=null,D.value={phone:!1,email:!1}},r=z({first_name:"",last_name:"",nickname:"",username:"",email:"",phone:"",password:"",role:"sales",is_active:!0,address:"",notes:"",images_ids:[],company_ids:((o=(n=u.modelValue)==null?void 0:n.companies)==null?void 0:o.map(d=>d.id))||[],...u.modelValue});fe(async()=>{if(h.fetchRoles(),P.isAdmin){j.value=!0;try{const d=await Me.getAll();_.value=d.data}finally{j.value=!1}}else P.isCompanyAdmin&&(_.value=P.companies)});const R=L(()=>P.isAdmin||P.isCompanyAdmin),A=L(()=>[...h.roles.map(d=>({title:d.label||d.name,value:d.name})),{title:"عميل",value:"customer"}]),Z=d=>{r.value.images_ids=[d.id],S.value=d.url},H=async()=>{const{valid:d}=await U.value.validate();if(d){M.value=!0;try{const t={...r.value};t.status=t.is_active?"active":"inactive",u.isEditMode&&!t.password&&delete t.password,N("save",t)}finally{M.value=!1}}};return ue(()=>u.modelValue,d=>{d&&(r.value={...r.value,...d},d.avatar_url&&(S.value=d.avatar_url))},{deep:!0,immediate:!0}),(d,t)=>(m(),O("div",ul,[e(Ee,{ref_key:"formRef",ref:U,onSubmit:ce(H,["prevent"]),class:"user-form pa-4"},{default:a(()=>[l("div",cl,[l("div",{class:"avatar-selection-zone position-relative cursor-pointer",onClick:t[1]||(t[1]=s=>b.value=!0)},[e(X,{size:"120",color:S.value?void 0:"primary-lighten-5",class:"border-2 border-dashed elevation-2 hover-scale overflow-hidden"},{default:a(()=>[S.value?(m(),g(Ae,{key:0,src:S.value,cover:""},null,8,["src"])):(m(),g(x,{key:1,icon:"ri-user-add-line",size:"40",color:"primary-lighten-1"})),l("div",ml,[e(x,{icon:"ri-camera-switch-line",color:"white",size:"24"}),t[16]||(t[16]=l("span",{class:"text-white text-caption mt-1 font-weight-bold"},"تغيير الصورة",-1))])]),_:1},8,["color"]),e(G,{icon:"ri-gallery-line",size:"x-small",color:"primary",class:"position-absolute bottom-0 right-0 elevation-4",onClick:t[0]||(t[0]=ce(s=>b.value=!0,["stop"]))})])]),e(je,null,{default:a(()=>[B.value&&!y.isEditMode?(m(),g(me,{key:0,type:"info",variant:"tonal",class:"mb-6 rounded-xl border-primary animate__animated animate__fadeIn","prepend-icon":"ri-user-shared-line"},{default:a(()=>[l("div",pl,[t[18]||(t[18]=l("div",null,[l("div",{class:"font-weight-bold"},"تم العثور على مستخدم موجود مسبقاً!"),l("div",{class:"text-caption"},"سيتم ربط هذا المستخدم بالشركة الحالية مع الحفاظ على هويته العالمية.")],-1)),e(G,{size:"small",variant:"text",color:"primary",onClick:I},{default:a(()=>t[17]||(t[17]=[k("مسح البيانات والبدء من جديد")])),_:1})])]),_:1})):C("",!0)]),_:1}),e(ae,null,{default:a(()=>[e(w,{cols:"12"},{default:a(()=>[l("div",fl,[e(x,{icon:"ri-information-line"}),t[19]||(t[19]=l("span",null,"المعلومات الأساسية",-1))]),e(se,{class:"mb-4"})]),_:1}),e(w,{cols:"12",md:"6"},{default:a(()=>[e(Q,{modelValue:r.value.phone,"onUpdate:modelValue":t[2]||(t[2]=s=>r.value.phone=s),label:"رقم الهاتف *",rules:[i(ee),i(al)],"prepend-inner-icon":"ri-phone-line",loading:F.value==="phone",onBlur:t[3]||(t[3]=s=>E("phone")),disabled:y.isEditMode},{"append-inner":a(()=>[D.value.phone?(m(),g(x,{key:0,icon:"ri-checkbox-circle-fill",color:"success"})):C("",!0)]),_:1},8,["modelValue","rules","loading","disabled"])]),_:1}),e(w,{cols:"12",md:"6"},{default:a(()=>[e(Q,{modelValue:r.value.email,"onUpdate:modelValue":t[4]||(t[4]=s=>r.value.email=s),label:"البريد الإلكتروني",type:"email",rules:[i(sl)],"prepend-inner-icon":"ri-mail-line",loading:F.value==="email",onBlur:t[5]||(t[5]=s=>E("email")),disabled:y.isEditMode},{"append-inner":a(()=>[D.value.email?(m(),g(x,{key:0,icon:"ri-checkbox-circle-fill",color:"success"})):C("",!0)]),_:1},8,["modelValue","rules","loading","disabled"])]),_:1}),e(w,{cols:"12",md:"4"},{default:a(()=>[e(Q,{modelValue:r.value.nickname,"onUpdate:modelValue":t[6]||(t[6]=s=>r.value.nickname=s),label:"الاسم المختصر (اللقب) *",rules:[i(ee)],"prepend-inner-icon":"ri-user-star-line"},null,8,["modelValue","rules"])]),_:1}),e(w,{cols:"12",md:"4"},{default:a(()=>[e(Q,{modelValue:r.value.first_name,"onUpdate:modelValue":t[7]||(t[7]=s=>r.value.first_name=s),label:"الاسم الأول *",rules:[i(ee)],"prepend-inner-icon":"ri-user-line"},null,8,["modelValue","rules"])]),_:1}),e(w,{cols:"12",md:"4"},{default:a(()=>[e(Q,{modelValue:r.value.last_name,"onUpdate:modelValue":t[8]||(t[8]=s=>r.value.last_name=s),label:"الاسم الأخير *",rules:[i(ee)],"prepend-inner-icon":"ri-user-line"},null,8,["modelValue","rules"])]),_:1}),e(w,{cols:"12",md:"6"},{default:a(()=>[e(Q,{modelValue:r.value.username,"onUpdate:modelValue":t[9]||(t[9]=s=>r.value.username=s),label:"اسم المستخدم (Username)",rules:[],"prepend-inner-icon":"ri-at-line"},null,8,["modelValue"])]),_:1}),e(w,{cols:"12",md:"6"},{default:a(()=>[e(oe,{modelValue:r.value.role,"onUpdate:modelValue":t[10]||(t[10]=s=>r.value.role=s),items:A.value,label:"الدور الوظيفي","prepend-inner-icon":"ri-shield-user-line",variant:"outlined",density:"comfortable"},null,8,["modelValue","items"])]),_:1}),r.value.id?C("",!0):(m(),g(w,{key:0,cols:"12",class:"mt-4"},{default:a(()=>[l("div",vl,[e(x,{icon:"ri-lock-password-line"}),t[20]||(t[20]=l("span",null,"الأمان والحالة",-1))]),e(se,{class:"mb-4"})]),_:1})),r.value.id?C("",!0):(m(),g(w,{key:1,cols:"12",md:"6"},{default:a(()=>[e(ll,{modelValue:r.value.password,"onUpdate:modelValue":t[11]||(t[11]=s=>r.value.password=s),label:y.isEditMode?"كلمة المرور (اتركها فارغة للتخطي)":"كلمة المرور *",rules:y.isEditMode?[]:[i(ee),i(tl)(8)],"prepend-inner-icon":"ri-lock-line"},null,8,["modelValue","label","rules"])]),_:1})),e(w,{cols:"12",md:"6"},{default:a(()=>[e(q,{variant:"tonal",color:r.value.is_active?"success":"error",class:"pa-2 rounded-lg d-flex align-center justify-space-between",height:"56"},{default:a(()=>[l("span",gl,v(r.value.is_active?"المستخدم نشط":"المستخدم معطل"),1),e(el,{modelValue:r.value.is_active,"onUpdate:modelValue":t[12]||(t[12]=s=>r.value.is_active=s),"hide-details":""},null,8,["modelValue"])]),_:1},8,["color"])]),_:1}),R.value?(m(),g(w,{key:2,cols:"12",class:"mt-4"},{default:a(()=>[l("div",yl,[e(x,{icon:"ri-community-line"}),t[21]||(t[21]=l("span",null,"ربط الشركات",-1))]),e(se,{class:"mb-4"}),e(oe,{modelValue:r.value.company_ids,"onUpdate:modelValue":t[13]||(t[13]=s=>r.value.company_ids=s),items:_.value,"item-title":"name","item-value":"id",label:"الشركات المرتبطة",multiple:"",chips:"","closable-chips":"",variant:"outlined","prepend-inner-icon":"ri-building-line",loading:j.value,hint:"يمكن للمسؤول ربط المستخدم بالشركات التي يديرها","persistent-hint":""},null,8,["modelValue","items","loading"])]),_:1})):C("",!0)]),_:1}),l("div",hl,[e(pe,{variant:"tonal",color:"grey",onClick:t[14]||(t[14]=s=>d.$emit("cancel"))},{default:a(()=>t[22]||(t[22]=[k("إلغاء")])),_:1}),e(pe,{loading:M.value,color:"primary",class:"px-8 font-weight-bold rounded-pill",onClick:H},{default:a(()=>[e(x,{icon:r.value.id?"ri-user-received-line":"ri-save-line",class:"me-2"},null,8,["icon"]),k(" "+v(y.isEditMode?"تحديث البيانات":r.value.id?"ربط الحساب":"إنشاء المستخدم"),1)]),_:1},8,["loading"])]),e(Ke,{modelValue:b.value,"onUpdate:modelValue":t[15]||(t[15]=s=>b.value=s),type:"avatar",onSelect:Z},null,8,["modelValue"])]),_:1},512)]))}},bl=_e(xl,[["__scopeId","data-v-5806c182"]]),_l={class:"glass-header d-flex align-center justify-space-between pa-6"},wl={class:"d-flex align-center gap-4"},kl={class:"text-h5 font-weight-bold text-white"},Vl={class:"header-text"},Cl={class:"d-flex align-center gap-2 mt-1"},Ul={class:"text-subtitle-1 text-white opacity-90"},$l={class:"main-layout-wrapper d-flex"},zl={class:"nav-rail-glass py-6"},Pl={class:"nav-rail-content d-flex flex-column gap-4 px-3"},Sl={class:"d-flex flex-column align-center gap-2"},Ml={class:"text-caption font-weight-bold"},Al={class:"flex-grow-1 content-glass-bg"},jl={class:"d-flex flex-column h-100"},El={class:"flex-grow-1 overflow-y-auto pa-6"},Il={class:"section-banner pa-6 rounded-xl mb-6 elevation-1 overflow-hidden"},Ol={class:"d-flex align-center justify-space-between relative-z"},Bl={class:"d-flex align-start gap-3"},Dl={class:"flex-grow-1"},Ll={class:"d-flex align-center justify-space-between mb-1"},Fl={class:"font-weight-black text-body-1"},Rl={class:"text-caption text-grey-darken-1 mb-2 line-clamp-2"},Gl={class:"d-flex gap-2"},Tl={class:"d-flex flex-column h-100"},Nl={class:"permissions-toolbar-glass px-6 py-4 border-b"},ql={class:"flex-grow-1 overflow-y-auto pa-6"},Hl={class:"permission-group-premium rounded-xl overflow-hidden elevation-1 bg-white mb-6"},Jl={class:"group-header pa-4 d-flex align-center justify-space-between border-b bg-grey-lighten-5"},Wl={class:"d-flex align-center gap-3"},Ql={class:"font-weight-black text-subtitle-2"},Yl={class:"text-caption text-grey"},Xl={key:1,class:"h-100 d-flex flex-column align-center justify-center py-12 opacity-40"},Zl={class:"glass-footer pa-4 d-flex align-center justify-space-between"},Kl={class:"d-flex align-center gap-2 text-grey-darken-1"},ea={class:"d-flex gap-3"},la={__name:"UserPermissionManager",props:{user:{type:Object,required:!0}},emits:["save","cancel"],setup(y,{emit:T}){const u=y,N=T,h=ie(),P=z(!1),U=z("roles"),M=z(!1),j=z(""),b=z([]),_=z([]),S=L(()=>[{label:"الأدوار",value:"roles",icon:"ri-shield-user-line",activeIcon:"ri-shield-check-fill",count:b.value.length},{label:"الصلاحيات",value:"permissions",icon:"ri-key-2-line",activeIcon:"ri-key-fill",count:_.value.length}]);fe(async()=>{h.loading=!0;try{await Promise.all([h.fetchRoles(),h.fetchAvailablePermissions()]),b.value=u.user.roles||[],_.value=u.user.direct_permissions||[]}finally{h.loading=!1}});const F=()=>{const p=u.user.full_name||u.user.username||"User",n=p.trim().split(" ");return n.length>=2?(n[0][0]+n[n.length-1][0]).toUpperCase():p.substring(0,2).toUpperCase()},B=p=>b.value.includes(p),D=p=>{const n=b.value.indexOf(p);n>-1?b.value.splice(n,1):b.value.push(p)},E=L(()=>{const p=new Set;return b.value.forEach(n=>{const o=h.roles.find(d=>d.name===n);o&&o.permissions&&o.permissions.forEach(d=>p.add(d))}),p}),I=p=>E.value.has(p),r=L(()=>{const p={},n=j.value.toLowerCase();return Object.entries(h.availablePermissions).forEach(([o,d])=>{var V,K;const t={name:d.name};let s=!1;(K=(V=d.name)==null?void 0:V.label)!=null&&K.toLowerCase().includes(n)?(s=!0,Object.entries(d).forEach(([J,W])=>{J!=="name"&&(t[J]=W)})):Object.entries(d).forEach(([J,W])=>{J!=="name"&&(W.label.toLowerCase().includes(n)||W.key.toLowerCase().includes(n))&&(t[J]=W,s=!0)}),s&&(p[o]=t)}),p}),R=p=>({admin:"ri-admin-line",companies:"ri-community-line",users:"ri-user-settings-line",warehouses:"ri-home-gear-line",products:"ri-box-3-line",invoices:"ri-file-list-3-line",transactions:"ri-hand-coin-line",cash_boxes:"ri-safe-2-line"})[p]||"ri-folder-keyhole-line",A=p=>Object.entries(p).filter(([o])=>o!=="name").map(([,o])=>o.key).every(o=>_.value.includes(o)||I(o)),Z=p=>{const n=Object.entries(p).filter(([d])=>d!=="name").map(([,d])=>d.key),o=A(p);n.forEach(d=>{if(I(d))return;const t=_.value.indexOf(d);o?t>-1&&_.value.splice(t,1):t===-1&&_.value.push(d)})},H=async()=>{P.value=!0;try{const p={roles:b.value,permissions:_.value};await h.updateUser(u.user.id,p),N("save")}catch(p){console.error("Failed to update permissions:",p)}finally{P.value=!1}};return(p,n)=>(m(),g(q,{class:"user-permission-manager-premium overflow-hidden",elevation:"0"},{default:a(()=>[l("div",_l,[l("div",wl,[e(X,{size:"64",class:"avatar-gradient elevation-4"},{default:a(()=>[l("span",kl,v(F()),1)]),_:1}),l("div",Vl,[n[8]||(n[8]=l("h2",{class:"text-h5 font-weight-black text-white mb-0"},"إدارة صلاحيات الوصول",-1)),l("div",Cl,[e(x,{icon:"ri-user-smile-line",size:"16",color:"white",class:"opacity-80"}),l("span",Ul,v(y.user.full_name||y.user.username),1)])])]),e(G,{icon:"ri-close-line",variant:"tonal",color:"white",class:"close-btn-hover",onClick:n[0]||(n[0]=o=>p.$emit("cancel"))})]),l("div",$l,[l("div",zl,[l("div",Pl,[(m(!0),O(Y,null,le(S.value,o=>(m(),g(G,{key:o.value,active:U.value===o.value,color:U.value===o.value?"primary":"grey-darken-1",variant:"text",class:"nav-item-premium py-8 rounded-xl",block:"",onClick:d=>U.value=o.value},{default:a(()=>[l("div",Sl,[e(x,{icon:U.value===o.value?o.activeIcon:o.icon,size:"28"},null,8,["icon"]),l("span",Ml,v(o.label),1),o.count?(m(),g(Ie,{key:0,content:o.count,color:"primary",floating:"","offset-x":"-10","offset-y":"-10"},null,8,["content"])):C("",!0)])]),_:2},1032,["active","color","onClick"]))),128))])]),l("div",Al,[e(Oe,{modelValue:U.value,"onUpdate:modelValue":n[6]||(n[6]=o=>U.value=o),class:"content-window"},{default:a(()=>[e(he,{value:"roles",class:"h-100"},{default:a(()=>[l("div",jl,[l("div",El,[l("div",Il,[l("div",Ol,[n[9]||(n[9]=l("div",null,[l("h3",{class:"text-h6 font-weight-black primary--text mb-1"},"الأدوار الوظيفية"),l("p",{class:"text-body-2 text-grey-darken-1"},"حدد الأدوار التي تعكس مسؤوليات المستخدم في النظام")],-1)),e(te,{color:"primary",variant:"flat",size:"large",class:"px-6 font-weight-bold"},{default:a(()=>[k(v(b.value.length)+" / "+v(i(h).roles.length)+" موزع ",1)]),_:1})]),n[10]||(n[10]=l("div",{class:"banner-circle shadow-accent"},null,-1))]),i(h).roles.length?(m(),g(ae,{key:0,dense:"",class:"role-grid"},{default:a(()=>[(m(!0),O(Y,null,le(i(h).roles,(o,d)=>(m(),g(w,{key:o.id,cols:"12",sm:"6",lg:"4"},{default:a(()=>[e(Be,null,{default:a(({isHovering:t,props:s})=>[e(q,De({ref_for:!0},s,{variant:B(o.name)?"flat":"outlined",color:B(o.name)?"primary":"grey-lighten-2",class:["role-premium-card transition-all",{"selected-float":B(o.name),"hover-scale":t}],onClick:V=>D(o.name)}),{default:a(()=>[e(Le,{class:"pa-4"},{default:a(()=>[l("div",Bl,[e(xe,{modelValue:b.value,"onUpdate:modelValue":n[1]||(n[1]=V=>b.value=V),value:o.name,color:"primary","hide-details":"",density:"compact",onClick:n[2]||(n[2]=ce(()=>{},["stop"]))},null,8,["modelValue","value"]),l("div",Dl,[l("div",Ll,[l("span",Fl,v(o.label||o.name),1)]),l("p",Rl,v(o.description||"لا يوجد وصف متاح"),1),l("div",Gl,[o.permissions_count?(m(),g(te,{key:0,size:"x-small",variant:"tonal",color:"primary"},{default:a(()=>[e(x,{icon:"ri-key-fill",size:"10",class:"me-1"}),k(" "+v(o.permissions_count)+" صلاحية ",1)]),_:2},1024)):C("",!0)])])])]),_:2},1024)]),_:2},1040,["variant","color","class","onClick"])]),_:2},1024)]),_:2},1024))),128))]),_:1})):C("",!0)])])]),_:1}),e(he,{value:"permissions",class:"h-100"},{default:a(()=>[l("div",Tl,[l("div",Nl,[e(ae,{dense:"",align:"center"},{default:a(()=>[e(w,{cols:"12",md:"7"},{default:a(()=>[e(Fe,{modelValue:j.value,"onUpdate:modelValue":n[3]||(n[3]=o=>j.value=o),placeholder:"ابحث عن صلاحية محددة...","prepend-inner-icon":"ri-search-2-line",variant:"solo",flat:"",density:"comfortable","hide-details":"",clearable:"",class:"premium-search-field","bg-color":"grey-lighten-4"},null,8,["modelValue"])]),_:1}),e(w,{cols:"12",md:"5"},{default:a(()=>[e(Re,{modelValue:M.value,"onUpdate:modelValue":n[4]||(n[4]=o=>M.value=o),mandatory:"",color:"primary",variant:"tonal",class:"w-100 expert-toggle-group",divided:""},{default:a(()=>[e(G,{value:!1,block:"",class:"flex-grow-1"},{default:a(()=>[e(x,{icon:"ri-filter-3-line",class:"me-2"}),n[11]||(n[11]=k(" المبسط "))]),_:1}),e(G,{value:!0,block:"",class:"flex-grow-1"},{default:a(()=>[e(x,{icon:"ri-magic-line",class:"me-2"}),n[12]||(n[12]=k(" الخبير "))]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1}),e(Ge,null,{default:a(()=>[M.value?(m(),g(me,{key:0,type:"info",variant:"tonal",density:"compact",class:"mt-4 rounded-xl text-caption border-none glass-alert-info"},{default:a(()=>[e(x,{icon:"ri-shield-flash-line",size:"16",class:"me-2"}),n[13]||(n[13]=l("strong",null,"وضع الخبير نشط:",-1)),n[14]||(n[14]=k(" يظهر الصلاحيات الموروثة من الأدوار لتمكين المراجعة الشاملة. "))]),_:1})):_.value.length>0?(m(),g(me,{key:1,type:"success",variant:"tonal",density:"compact",class:"mt-4 rounded-xl text-caption border-none glass-alert-success"},{default:a(()=>[e(x,{icon:"ri-checkbox-circle-line",size:"16",class:"me-2"}),n[15]||(n[15]=k(" لديك ")),l("strong",null,v(_.value.length),1),n[16]||(n[16]=k(" صلاحية مباشرة مخصصة لهذا المستخدم. "))]),_:1})):C("",!0)]),_:1})]),l("div",ql,[Object.keys(r.value).length?(m(),g(ae,{key:0},{default:a(()=>[(m(!0),O(Y,null,le(r.value,(o,d)=>(m(),g(w,{key:d,cols:"12"},{default:a(()=>{var t;return[l("div",Hl,[l("div",Jl,[l("div",Wl,[e(X,{color:"primary",variant:"tonal",size:"36"},{default:a(()=>[e(x,{icon:R(d),size:"20"},null,8,["icon"])]),_:2},1024),l("div",null,[l("span",Ql,v(((t=o.name)==null?void 0:t.label)||d),1),l("div",Yl,v(Object.keys(o).length-1)+" صلاحية",1)])]),e(G,{size:"small",variant:"tonal",color:A(o)?"grey":"primary",onClick:s=>Z(o)},{default:a(()=>[k(v(A(o)?"إلغاء الكل":"تحديد الكل"),1)]),_:2},1032,["color","onClick"])]),e(Te,{density:"comfortable",class:"py-0"},{default:a(()=>[(m(!0),O(Y,null,le(o,(s,V)=>(m(),O(Y,{key:V},[V!=="name"&&(M.value||!I(s.key))?(m(),O(Y,{key:0},[e(Ne,{class:"premium-perm-item px-4"},{prepend:a(()=>[e(xe,{modelValue:_.value,"onUpdate:modelValue":n[5]||(n[5]=K=>_.value=K),value:s.key,disabled:I(s.key),color:"primary","hide-details":""},null,8,["modelValue","value","disabled"])]),default:a(()=>[e(qe,{class:"d-flex align-center gap-2"},{default:a(()=>[l("span",{class:He([{"text-grey opacity-60 italic":I(s.key)},"font-weight-medium"])},v(s.label),3),I(s.key)?(m(),g(te,{key:0,size:"x-small",color:"primary",variant:"tonal",class:"px-2 font-weight-bold"},{default:a(()=>n[17]||(n[17]=[k(" من الأدوار ")])),_:1})):C("",!0)]),_:2},1024),e(Je,{class:"text-caption opacity-40"},{default:a(()=>[k(v(s.key),1)]),_:2},1024)]),_:2},1024),(m(),g(se,{key:"div-"+V,inset:""}))],64)):C("",!0)],64))),128))]),_:2},1024)])]}),_:2},1024))),128))]),_:1})):(m(),O("div",Xl,[e(x,{icon:"ri-search-eye-line",size:"100"}),n[18]||(n[18]=l("h4",{class:"text-h6 font-weight-bold mt-4"},"لا توجد صلاحيات تطابق بحثك",-1)),n[19]||(n[19]=l("p",{class:"text-body-2"},"حاول استخدام كلمات مفتاحية أخرى",-1))]))])])]),_:1})]),_:1},8,["modelValue"])])]),e(se),l("div",Zl,[l("div",Kl,[e(x,{icon:"ri-lock-2-line",size:"16"}),n[20]||(n[20]=l("span",{class:"text-caption"},"يتم تشفير وتأمين جميع تحديثات الصلاحيات فوراً",-1))]),l("div",ea,[e(G,{variant:"text",color:"grey-darken-1",class:"font-weight-bold",onClick:n[7]||(n[7]=o=>p.$emit("cancel"))},{default:a(()=>n[21]||(n[21]=[k(" تجاهل ")])),_:1}),e(G,{color:"primary",size:"large",class:"px-8 font-weight-black elevation-2",loading:P.value,"prepend-icon":"ri-shield-flash-line",rounded:"xl",onClick:H},{default:a(()=>n[22]||(n[22]=[k(" تحديث الصلاحيات ")])),_:1},8,["loading"])])])]),_:1}))}},aa=_e(la,[["__scopeId","data-v-d1950ebd"]]),sa={class:"users-page"},ta={class:"pa-4 d-flex align-center gap-4"},na={class:"text-h5 font-weight-bold primary--text"},oa={class:"pa-4 d-flex align-center gap-4"},ia={class:"text-h5 font-weight-bold text-success"},ra={class:"pa-4 d-flex align-center gap-4"},da={class:"text-h5 font-weight-bold text-warning"},ua={class:"pa-4 d-flex align-center gap-4"},ca={class:"text-h5 font-weight-bold text-error"},ma={class:"pa-4 d-flex align-center gap-3 flex-wrap"},pa={class:"d-flex align-center py-2"},fa={class:"d-flex flex-column"},va={class:"font-weight-bold text-body-1"},ga={class:"text-caption text-grey d-flex align-center gap-1"},ya={key:0,class:"d-flex align-center gap-1 text-body-2"},ha={class:"text-ltr"},xa={key:1,class:"text-caption text-grey italic"},ba={class:"d-flex flex-wrap gap-1"},_a={key:0,class:"text-caption text-grey italic"},wa={class:"px-6 pb-6"},Fa={__name:"UserList",setup(y){const{can:T}=Xe(),u=ie(),N=we(),{users:h,loading:P,totalItems:U,formData:M,isEditMode:j,isOpen:b,close:_,showConfirm:S,confirmMessage:F,handleConfirm:B,handleCancel:D,isPermissionOpen:E,permissionUser:I,openPermissions:r,closePermissions:R,loadUsers:A,loadMore:Z,saveUser:H,handleDelete:p,handleEdit:n,handleCreate:o}=dl(),d=async $=>{await H($),_()},t=async()=>{R(),await A()},s=()=>{P.value||!h.value||h.value.length>=(U.value||0)||Z()},V=[{title:"المستخدم",key:"full_name",sortable:!0},{title:"الهاتف",key:"phone",sortable:!0},{title:"الأدوار",key:"roles",sortable:!1},{title:"الحالة",key:"status",sortable:!0},{title:"تاريخ الإضافة",key:"created_at",sortable:!0},{title:"الإجراءات",key:"actions",sortable:!1,align:"end"}],K=[{title:"الكل",value:null},{title:"مدير عام",value:"admin.super"},{title:"مدير شركة",value:"admin.company"},{title:"موظف",value:"employee"}],J=[{title:"الكل",value:null},{title:"نشط",value:"active"},{title:"معطل",value:"inactive"}],W=L(()=>{var $;return(($=u.stats)==null?void 0:$.active)||0}),ke=L(()=>{var $;return(($=u.stats)==null?void 0:$.admins)||0}),Ve=L(()=>{var $;return(($=u.stats)==null?void 0:$.inactive)||0}),re=()=>{u.page=1,A()},Ce=()=>{u.page=1,A()},Ue=$=>{JSON.stringify(u.sortBy)!==JSON.stringify($.sortBy)&&(u.sortBy=$.sortBy,A())},$e=$=>{r($)};return fe(()=>{u.page=1,A(!1),u.fetchStats()}),ue(()=>u.search,()=>{u.page=1,A(!1)}),ue(()=>u.itemsPerPage,()=>{u.page=1,A(!1)}),($,f)=>{var ve,ge;const ze=Q,Pe=Se;return m(),O("div",sa,[e(ae,{class:"mb-6"},{default:a(()=>[e(w,{cols:"12",sm:"6",md:"3"},{default:a(()=>[e(q,{class:"rounded-xl border border-primary-lighten-4 elevation-sm overflow-hidden"},{default:a(()=>[l("div",ta,[e(X,{color:"primary-lighten-5",rounded:"lg",size:"48"},{default:a(()=>[e(x,{icon:"ri-team-line",color:"primary"})]),_:1}),l("div",null,[f[11]||(f[11]=l("div",{class:"text-caption text-grey-darken-1 font-weight-medium"},"إجمالي المستخدمين",-1)),l("div",na,v(i(U)||0),1)])])]),_:1})]),_:1}),e(w,{cols:"12",sm:"6",md:"3"},{default:a(()=>[e(q,{class:"rounded-xl border border-success-lighten-4 elevation-sm overflow-hidden"},{default:a(()=>[l("div",oa,[e(X,{color:"success-lighten-5",rounded:"lg",size:"48"},{default:a(()=>[e(x,{icon:"ri-user-follow-line",color:"success"})]),_:1}),l("div",null,[f[12]||(f[12]=l("div",{class:"text-caption text-grey-darken-1 font-weight-medium"},"نشطين الآن",-1)),l("div",ia,v(W.value),1)])])]),_:1})]),_:1}),e(w,{cols:"12",sm:"6",md:"3"},{default:a(()=>[e(q,{class:"rounded-xl border border-warning-lighten-4 elevation-sm overflow-hidden"},{default:a(()=>[l("div",ra,[e(X,{color:"warning-lighten-5",rounded:"lg",size:"48"},{default:a(()=>[e(x,{icon:"ri-admin-line",color:"warning"})]),_:1}),l("div",null,[f[13]||(f[13]=l("div",{class:"text-caption text-grey-darken-1 font-weight-medium"},"المدراء",-1)),l("div",da,v(ke.value),1)])])]),_:1})]),_:1}),e(w,{cols:"12",sm:"6",md:"3"},{default:a(()=>[e(q,{class:"rounded-xl border border-error-lighten-4 elevation-sm overflow-hidden"},{default:a(()=>[l("div",ua,[e(X,{color:"error-lighten-5",rounded:"lg",size:"48"},{default:a(()=>[e(x,{icon:"ri-user-forbid-line",color:"error"})]),_:1}),l("div",null,[f[14]||(f[14]=l("div",{class:"text-caption text-grey-darken-1 font-weight-medium"},"معطلين",-1)),l("div",ca,v(Ve.value),1)])])]),_:1})]),_:1})]),_:1}),e(q,{class:"rounded-xl border border-grey-lighten-4 mb-6 elevation-sm overflow-visible"},{default:a(()=>[l("div",ma,[e(ze,{modelValue:i(u).search,"onUpdate:modelValue":[f[0]||(f[0]=c=>i(u).search=c),Ce],label:"بحث بالمستخدم...","prepend-inner-icon":"ri-search-line",density:"compact","hide-details":"",class:"max-width-300 flex-grow-1 flex-sm-grow-0"},null,8,["modelValue"]),e(oe,{modelValue:i(u).roleFilter,"onUpdate:modelValue":[f[1]||(f[1]=c=>i(u).roleFilter=c),re],items:K,label:"الدور",density:"compact","hide-details":"",clearable:"",class:"max-width-200"},null,8,["modelValue"]),e(oe,{modelValue:i(u).statusFilter,"onUpdate:modelValue":[f[2]||(f[2]=c=>i(u).statusFilter=c),re],items:J,label:"الحالة",density:"compact","hide-details":"",clearable:"",class:"max-width-200"},null,8,["modelValue"]),i(N).isAdmin||i(T)("users.view_all")?(m(),g(Qe,{key:0,modelValue:i(u).isGlobalMode,"onUpdate:modelValue":[f[3]||(f[3]=c=>i(u).isGlobalMode=c),re],label:"عرض عالمي",color:"primary","hide-details":"",inset:"",density:"compact",class:"ml-4"},null,8,["modelValue"])):C("",!0),e(Ye),i(T)("users.create")?(m(),g(pe,{key:1,color:"primary","prepend-icon":"ri-user-add-line",class:"font-weight-bold rounded-pill",onClick:i(o)},{default:a(()=>f[15]||(f[15]=[k(" مستخدم جديد ")])),_:1},8,["onClick"])):C("",!0)])]),_:1}),e(il,{loading:i(P)&&((ve=i(h))==null?void 0:ve.length)>0,"has-more":(((ge=i(h))==null?void 0:ge.length)||0)<(i(U)||0),"no-more-text":"لا يوجد المزيد من المستخدمين",onLoad:s},{default:a(()=>[e(nl,{page:i(u).page,"onUpdate:page":f[4]||(f[4]=c=>i(u).page=c),"items-per-page":i(u).itemsPerPage,"onUpdate:itemsPerPage":f[5]||(f[5]=c=>i(u).itemsPerPage=c),"sort-by":i(u).sortBy,"onUpdate:sortBy":f[6]||(f[6]=c=>i(u).sortBy=c),headers:V,items:i(h)||[],"total-items":i(U)||0,loading:i(P),"hide-pagination":"","permission-module":"users","onUpdate:options":Ue,onEdit:i(n),onDelete:i(p)},{"item.full_name":a(({item:c})=>[l("div",pa,[e(Pe,{"img-url":c.avatar_url,name:c.nickname||c.full_name,size:"45",class:"me-3 border shadow-sm"},null,8,["img-url","name"]),l("div",fa,[l("span",va,v(c.nickname||c.full_name),1),l("span",ga,[e(x,{icon:"ri-mail-line",size:"12"}),k(" "+v(c.email||"لا يوجد بريد"),1)])])])]),"item.phone":a(({item:c})=>[c.phone?(m(),O("div",ya,[e(x,{icon:"ri-phone-line",size:"14",color:"primary"}),l("span",ha,v(c.phone),1)])):(m(),O("span",xa,"لا يوجد"))]),"item.roles":a(({item:c})=>{var de;return[l("div",ba,[(m(!0),O(Y,null,le(c.roles,ye=>(m(),g(te,{key:ye,size:"x-small",variant:"flat",color:"secondary-lighten-5",class:"text-secondary font-weight-bold px-2 rounded"},{default:a(()=>[k(v(ye),1)]),_:2},1024))),128)),(de=c.roles)!=null&&de.length?C("",!0):(m(),O("span",_a,"موظف"))])]}),"item.status":a(({item:c})=>[e(te,{color:c.status==="active"||c.status===1?"success":"error",size:"x-small",variant:"flat",class:"font-weight-bold px-2"},{default:a(()=>[k(v(c.status==="active"||c.status===1?"نشط":"معطل"),1)]),_:2},1032,["color"])]),"extra-actions":a(({item:c})=>[i(T)("roles.page")?(m(),g(G,{key:0,icon:"ri-shield-user-line",size:"small",variant:"text",color:"warning",tooltip:"إدارة الصلاحيات",onClick:de=>$e(c)},null,8,["onClick"])):C("",!0)]),_:1},8,["page","items-per-page","sort-by","items","total-items","loading","onEdit","onDelete"])]),_:1},8,["loading","has-more"]),l("div",wa,[e(rl,{modelValue:i(S),"onUpdate:modelValue":f[7]||(f[7]=c=>ne(S)?S.value=c:null),message:i(F),onConfirm:i(B),onCancel:i(D)},null,8,["modelValue","message","onConfirm","onCancel"])]),e(ol,{modelValue:i(b),"onUpdate:modelValue":f[9]||(f[9]=c=>ne(b)?b.value=c:null),title:i(j)?"تعديل بيانات المستخدم":"إضافة مستخدم جديد",icon:i(j)?"ri-user-edit-line":"ri-user-add-line","max-width":"800","hide-actions":""},{default:a(()=>[e(bl,{modelValue:i(M),"onUpdate:modelValue":f[8]||(f[8]=c=>ne(M)?M.value=c:null),"is-edit-mode":i(j),onSave:d,onCancel:i(_)},null,8,["modelValue","is-edit-mode","onCancel"])]),_:1},8,["modelValue","title","icon"]),e(We,{modelValue:i(E),"onUpdate:modelValue":f[10]||(f[10]=c=>ne(E)?E.value=c:null),"max-width":"900",scrollable:"",transition:"dialog-bottom-transition"},{default:a(()=>[i(E)?(m(),g(aa,{key:0,user:i(I),onSave:t,onCancel:i(R)},null,8,["user","onCancel"])):C("",!0)]),_:1},8,["modelValue"])])}}};export{Fa as default};
