import{r as x,K as J,v as u,w as l,V as W,S as X,o,a as t,b as n,t as i,c,D as d,u as g,m as p,d as z,e as y,h as A,ag as Y,i as B,F as E,Q as Z,C as I,N as S,ad as tt,n as et,P as st,z as lt,A as at,a2 as ot,a3 as nt}from"./index-DPR0tjT6.js";import{u as it}from"./useApi-CTBDEoea.js";import{u as rt}from"./usePermissions-BOh6stgy.js";import{u as dt}from"./usePrintExport-BD2QUCTi.js";import{_ as b}from"./AppButton-DiF3_7lr.js";import{_ as h}from"./AppCard-DxtAeMMp.js";import{A as ut}from"./AppDialog-CVbZwWX_.js";import{_ as ct}from"./LoadingSpinner-BZRbwFnn.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const pt={class:"d-flex align-center justify-space-between mb-6"},mt={class:"d-flex align-center"},vt={class:"text-h4 font-weight-bold"},ft={key:0,class:"text-body-1 text-grey"},yt={class:"d-flex gap-2 no-print"},_t={key:0,class:"d-flex justify-center align-center py-12"},xt={id:"invoice-content"},gt={class:"font-weight-bold text-h6"},bt={class:"font-weight-bold text-h6"},ht={class:"font-weight-medium"},wt={class:"font-weight-medium"},kt={class:"font-weight-bold"},Vt={key:0,class:"text-caption text-grey"},Ct={class:"text-center"},Dt={class:"text-left text-body-2"},It={class:"text-left text-body-2 text-error"},St={class:"text-left font-weight-bold text-success"},jt={key:1,class:"text-center py-6 text-grey"},Lt={class:"d-flex flex-column gap-4"},Pt={class:"d-flex flex-column gap-2 mb-4"},$t={class:"d-flex justify-space-between text-body-2"},zt={class:"font-weight-medium"},At={key:0,class:"d-flex justify-space-between text-body-2 text-error"},Bt={key:1,class:"d-flex justify-space-between text-body-2"},Et={key:2,class:"d-flex justify-space-between text-body-2"},Nt={class:"d-flex justify-space-between align-center mb-4"},Ft={class:"text-h5 font-weight-black text-success"},Gt={class:"d-flex flex-column gap-2 p-2 rounded-lg bg-grey-lighten-4"},Rt={class:"d-flex justify-space-between text-body-2"},Tt={class:"font-weight-bold text-info"},Mt={key:0,class:"d-flex justify-space-between text-body-2"},Ut={class:"font-weight-bold text-error"},qt={key:1,class:"text-center text-success font-weight-bold py-1"},ee={__name:"InvoiceView",setup(Kt){const C=et(),w=X(),{can:_}=rt(),{printElement:N}=dt(),D=it("/api/invoices"),j=x(!0),s=x(null),k=x(!1),F=x(!1),V=x(null),G=[{title:"مسودة",value:"draft"},{title:"قيد الانتظار",value:"pending"},{title:"معتمدة",value:"approved"},{title:"ملغاة",value:"cancelled"}],R=()=>C.push("/invoices"),T=()=>C.push(`/invoices/${w.params.id}/edit`),M=()=>{var a;N("invoice-content",`فاتورة #${(a=s.value)==null?void 0:a.invoice_number}`)},U=async()=>{try{await D.remove(w.params.id,{successMessage:"تم حذف الفاتورة"}),C.push("/invoices")}finally{k.value=!1}},q=async a=>{try{await D.update(w.params.id,{status:a}),s.value.status=a}catch{V.value=s.value.status}},L=a=>a?new Date(a).toLocaleDateString("ar-EG"):"-",m=a=>a?new Intl.NumberFormat("ar-EG",{style:"currency",currency:"EGP"}).format(a):"0.00 ج.م",K=a=>({draft:"grey",pending:"warning",approved:"success",cancelled:"error"})[a]||"grey",O=a=>({draft:"مسودة",pending:"قيد الانتظار",approved:"معتمدة",cancelled:"ملغاة"})[a]||a,Q=a=>({unpaid:"error",partial:"warning",paid:"success"})[a]||"grey",H=a=>({unpaid:"غير مدفوعة",partial:"مدفوعة جزئياً",paid:"مدفوعة بالكامل"})[a]||a;return J(async()=>{try{const a=await D.getById(w.params.id);s.value=a.data,V.value=s.value.status}finally{j.value=!1}}),(a,e)=>(o(),u(W,{fluid:""},{default:l(()=>{var P;return[t("div",pt,[t("div",mt,[n(b,{icon:"ri-arrow-right-line",variant:"text",color:"secondary",onClick:R,class:"me-3"}),t("div",null,[t("h1",vt,"الفاتورة #"+i((P=s.value)==null?void 0:P.invoice_number),1),s.value?(o(),c("p",ft,i(L(s.value.invoice_date)),1)):d("",!0)])]),t("div",yt,[g(_)("invoices.update_all")?(o(),u(b,{key:0,color:"primary","prepend-icon":"ri-edit-line",onClick:T},{default:l(()=>e[4]||(e[4]=[p(" تعديل ")])),_:1})):d("",!0),g(_)("invoices.print")?(o(),u(b,{key:1,color:"info","prepend-icon":"ri-printer-line",onClick:M},{default:l(()=>e[5]||(e[5]=[p(" طباعة ")])),_:1})):d("",!0),g(_)("invoices.delete_all")?(o(),u(b,{key:2,color:"error","prepend-icon":"ri-delete-bin-line",onClick:e[0]||(e[0]=r=>k.value=!0)},{default:l(()=>e[6]||(e[6]=[p(" حذف ")])),_:1})):d("",!0)])]),j.value?(o(),c("div",_t,[n(ct)])):d("",!0),t("div",xt,[s.value?(o(),u(z,{key:0},{default:l(()=>[n(y,{cols:"12",md:"8"},{default:l(()=>[n(h,{title:"معلومات العميل",icon:"ri-user-line",class:"mb-6"},{default:l(()=>[n(z,null,{default:l(()=>{var r,v;return[n(y,{cols:"12",sm:"6"},{default:l(()=>{var f;return[e[7]||(e[7]=t("div",{class:"text-caption text-grey mb-1"},"الاسم الكامل",-1)),t("div",gt,i((f=s.value.customer)==null?void 0:f.name),1)]}),_:1}),n(y,{cols:"12",sm:"6"},{default:l(()=>{var f;return[e[8]||(e[8]=t("div",{class:"text-caption text-grey mb-1"},"رقم الهاتف",-1)),t("div",bt,[n(A,{icon:"ri-phone-line",size:"small",class:"me-1"}),p(" "+i((f=s.value.customer)==null?void 0:f.phone),1)])]}),_:1}),(r=s.value.customer)!=null&&r.email?(o(),u(y,{key:0,cols:"12",sm:"6"},{default:l(()=>[e[9]||(e[9]=t("div",{class:"text-caption text-grey mb-1"},"البريد الإلكتروني",-1)),t("div",ht,i(s.value.customer.email),1)]),_:1})):d("",!0),(v=s.value.customer)!=null&&v.address?(o(),u(y,{key:1,cols:"12",sm:"6"},{default:l(()=>[e[10]||(e[10]=t("div",{class:"text-caption text-grey mb-1"},"العنوان",-1)),t("div",wt,i(s.value.customer.address),1)]),_:1})):d("",!0)]}),_:1})]),_:1}),n(h,{title:"عناصر الفاتورة",icon:"ri-list-check-2",class:"mb-6"},{default:l(()=>[n(Y,null,{default:l(()=>[e[11]||(e[11]=t("thead",null,[t("tr",null,[t("th",{class:"text-right"},"المنتج"),t("th",{class:"text-center"},"الكمية"),t("th",{class:"text-left"},"السعر"),t("th",{class:"text-left"},"الخصم"),t("th",{class:"text-left font-weight-bold"},"الإجمالي")])],-1)),t("tbody",null,[(o(!0),c(E,null,B(s.value.items,r=>(o(),c("tr",{key:r.id},[t("td",null,[t("div",kt,i(r.product_name),1),r.variant_name?(o(),c("div",Vt,i(r.variant_name),1)):d("",!0)]),t("td",Ct,[n(I,{size:"small",variant:"tonal",color:"primary"},{default:l(()=>[p(i(r.quantity),1)]),_:2},1024)]),t("td",Dt,i(m(r.unit_price)),1),t("td",It,i(r.discount_percentage)+"%",1),t("td",St,i(m(r.total)),1)]))),128))])]),_:1})]),_:1}),n(h,{title:"سجل المدفوعات",icon:"ri-history-line"},{actions:l(()=>[s.value.payment_status!=="paid"?(o(),u(b,{key:0,variant:"outlined","prepend-icon":"ri-add-line",size:"small",class:"no-print",onClick:e[1]||(e[1]=r=>F.value=!0)},{default:l(()=>e[12]||(e[12]=[p(" إضافة دفعة ")])),_:1})):d("",!0)]),default:l(()=>{var r;return[(r=s.value.payments)!=null&&r.length?(o(),u(Z,{key:0,class:"pa-0"},{default:l(()=>[(o(!0),c(E,null,B(s.value.payments,(v,f)=>(o(),u(st,{key:v.id,class:lt({"border-bottom":f<s.value.payments.length-1})},{prepend:l(()=>[n(at,{color:"success-lighten-5",size:"40",class:"me-3"},{default:l(()=>[n(A,{icon:"ri-money-dollar-circle-line",color:"success"})]),_:1})]),default:l(()=>[n(ot,{class:"font-weight-bold text-success"},{default:l(()=>[p(i(m(v.amount)),1)]),_:2},1024),n(nt,null,{default:l(()=>{var $;return[p(i(L(v.payment_date))+" - "+i(($=v.payment_method)==null?void 0:$.name),1)]}),_:2},1024)]),_:2},1032,["class"]))),128))]),_:1})):(o(),c("div",jt,"لا توجد مدفوعات مسجلة لهذه الفاتورة."))]}),_:1})]),_:1}),n(y,{cols:"12",md:"4"},{default:l(()=>[n(h,{title:"الحالة والمتابعة",icon:"ri-settings-4-line",class:"mb-6"},{default:l(()=>[t("div",Lt,[t("div",null,[e[13]||(e[13]=t("div",{class:"text-caption text-grey mb-1"},"حالة الفاتورة العامة",-1)),n(I,{color:K(s.value.status),variant:"tonal",class:"px-4 font-weight-bold"},{default:l(()=>[p(i(O(s.value.status)),1)]),_:1},8,["color"])]),t("div",null,[e[14]||(e[14]=t("div",{class:"text-caption text-grey mb-1"},"حالة تحصيل المبالغ",-1)),n(I,{color:Q(s.value.payment_status),variant:"tonal",class:"px-4 font-weight-bold"},{default:l(()=>[p(i(H(s.value.payment_status)),1)]),_:1},8,["color"])]),g(_)("invoices.update_all")?(o(),u(S,{key:0,class:"no-print"})):d("",!0),g(_)("invoices.update_all")?(o(),u(tt,{key:1,modelValue:V.value,"onUpdate:modelValue":[e[2]||(e[2]=r=>V.value=r),q],items:G,label:"تغيير الحالة",variant:"outlined",density:"comfortable",class:"no-print mt-2","hide-details":""},null,8,["modelValue"])):d("",!0)])]),_:1}),n(h,{title:"الملخص المالي",icon:"ri-money-dollar-box-line"},{default:l(()=>[t("div",Pt,[t("div",$t,[e[15]||(e[15]=t("span",{class:"text-grey"},"المجموع الفرعي:",-1)),t("span",zt,i(m(s.value.subtotal)),1)]),s.value.discount_amount>0?(o(),c("div",At,[e[16]||(e[16]=t("span",null,"إجمالي الخصم:",-1)),t("span",null,"-"+i(m(s.value.discount_amount)),1)])):d("",!0),s.value.tax_amount>0?(o(),c("div",Bt,[e[17]||(e[17]=t("span",{class:"text-grey"},"إجمالي الضريبة:",-1)),t("span",null,i(m(s.value.tax_amount)),1)])):d("",!0),s.value.shipping_cost>0?(o(),c("div",Et,[e[18]||(e[18]=t("span",{class:"text-grey"},"تكلفة الشحن:",-1)),t("span",null,i(m(s.value.shipping_cost)),1)])):d("",!0)]),n(S,{class:"my-4"}),t("div",Nt,[e[19]||(e[19]=t("span",{class:"text-h6 font-weight-bold"},"إجمالي الفاتورة:",-1)),t("span",Ft,i(m(s.value.total)),1)]),n(S,{class:"mb-4"}),t("div",Gt,[t("div",Rt,[e[20]||(e[20]=t("span",{class:"text-grey"},"إجمالي المدفوع:",-1)),t("span",Tt,i(m(s.value.paid_amount)),1)]),s.value.remaining>0?(o(),c("div",Mt,[e[21]||(e[21]=t("span",{class:"text-grey"},"المبلغ المتبقي:",-1)),t("span",Ut,i(m(s.value.remaining)),1)])):(o(),c("div",qt,"مدفوعة بالكامل"))])]),_:1})]),_:1})]),_:1})):d("",!0)]),n(ut,{modelValue:k.value,"onUpdate:modelValue":e[3]||(e[3]=r=>k.value=r),title:"تأكيد حذف الفاتورة",icon:"ri-delete-bin-line","confirm-color":"error","confirm-text":"حذف",onConfirm:U},{default:l(()=>e[22]||(e[22]=[p(" هل أنت متأكد من حذف هذه الفاتورة؟ لا يمكن التراجع عن هذا الإجراء وسيتم حذف الفاتورة وجميع المدفوعات المرتبطة بها نهائياً. ")])),_:1},8,["modelValue"])]}),_:1}))}};export{ee as default};
